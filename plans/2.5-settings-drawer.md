Now I have comprehensive information about the shadcn/ui components, form patterns, and timezone handling. Let me compile the complete, excruciating implementation details for all the settings components.

---

# Settings Drawer and Settings Screens - Complete Implementation Plan

## Overview

This document provides complete, copy-paste ready code for implementing the settings drawer and all settings screens for the Tether web UI. The implementation uses:

- **shadcn/ui** components (Drawer, Form, Button, Input, Select, etc.)
- **React Hook Form** with **Zod** for form validation
- **TanStack Query** for data fetching and mutations (generated via openapi-ts)
- **Lucide React** for icons

## Prerequisites

Before implementing, ensure these shadcn/ui components are installed:

```bash
bunx shadcn@latest add drawer button form input select label separator alert-dialog card badge toast switch
```

Required dependencies:

```bash
bun add react-hook-form zod @hookform/resolvers lucide-react
```

---

## File 1: `/Users/jeffrey/code/tether/web-ui/src/components/settings/SettingsDrawer.tsx`

```tsx
import * as React from "react";
import {
  Drawer,
  DrawerContent,
  DrawerHeader,
  DrawerTitle,
  DrawerDescription,
} from "@/components/ui/drawer";
import { Button } from "@/components/ui/button";
import { ChevronLeft } from "lucide-react";
import { SettingsMenu, SettingsSection } from "./SettingsMenu";
import { WifiSettings } from "./WifiSettings";
import { BluetoothSettings } from "./BluetoothSettings";
import { PassesSettings } from "./PassesSettings";
import { TimezoneSettings } from "./TimezoneSettings";
import { SystemSettings } from "./SystemSettings";

interface SettingsDrawerProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function SettingsDrawer({ open, onOpenChange }: SettingsDrawerProps) {
  const [currentSection, setCurrentSection] =
    React.useState<SettingsSection | null>(null);

  // Reset to menu when drawer closes
  React.useEffect(() => {
    if (!open) {
      // Delay reset to allow close animation
      const timer = setTimeout(() => {
        setCurrentSection(null);
      }, 300);
      return () => clearTimeout(timer);
    }
  }, [open]);

  const handleBack = () => {
    setCurrentSection(null);
  };

  const handleSectionSelect = (section: SettingsSection) => {
    setCurrentSection(section);
  };

  const getSectionTitle = (): string => {
    switch (currentSection) {
      case "wifi":
        return "Wi-Fi Networks";
      case "bluetooth":
        return "Bluetooth Device";
      case "passes":
        return "Monthly Passes";
      case "timezone":
        return "Timezone";
      case "system":
        return "System";
      default:
        return "Settings";
    }
  };

  const getSectionDescription = (): string => {
    switch (currentSection) {
      case "wifi":
        return "Manage your Wi-Fi network connections";
      case "bluetooth":
        return "Configure the device to track";
      case "passes":
        return "Set your monthly pass allowance";
      case "timezone":
        return "Configure your local timezone";
      case "system":
        return "System controls and information";
      default:
        return "Configure your Tether device";
    }
  };

  const renderSectionContent = () => {
    switch (currentSection) {
      case "wifi":
        return <WifiSettings />;
      case "bluetooth":
        return <BluetoothSettings />;
      case "passes":
        return <PassesSettings />;
      case "timezone":
        return <TimezoneSettings />;
      case "system":
        return <SystemSettings />;
      default:
        return <SettingsMenu onSelectSection={handleSectionSelect} />;
    }
  };

  return (
    <Drawer open={open} onOpenChange={onOpenChange}>
      <DrawerContent className="max-h-[85vh]">
        <div className="mx-auto w-full max-w-md">
          <DrawerHeader className="relative">
            {currentSection && (
              <Button
                variant="ghost"
                size="icon"
                className="absolute left-4 top-1/2 -translate-y-1/2"
                onClick={handleBack}
                aria-label="Back to settings menu"
              >
                <ChevronLeft className="h-5 w-5" />
              </Button>
            )}
            <DrawerTitle className="text-center">{getSectionTitle()}</DrawerTitle>
            <DrawerDescription className="text-center">
              {getSectionDescription()}
            </DrawerDescription>
          </DrawerHeader>

          <div className="overflow-y-auto px-4 pb-8">
            {renderSectionContent()}
          </div>
        </div>
      </DrawerContent>
    </Drawer>
  );
}
```

---

## File 2: `/Users/jeffrey/code/tether/web-ui/src/components/settings/SettingsMenu.tsx`

```tsx
import * as React from "react";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import {
  Wifi,
  Bluetooth,
  Ticket,
  Globe,
  Settings2,
  ChevronRight,
} from "lucide-react";
import type { LucideIcon } from "lucide-react";

export type SettingsSection =
  | "wifi"
  | "bluetooth"
  | "passes"
  | "timezone"
  | "system";

interface SettingsMenuItem {
  id: SettingsSection;
  label: string;
  description: string;
  icon: LucideIcon;
}

const menuItems: SettingsMenuItem[] = [
  {
    id: "wifi",
    label: "Wi-Fi Networks",
    description: "Manage network connections",
    icon: Wifi,
  },
  {
    id: "bluetooth",
    label: "Bluetooth Device",
    description: "Configure tracked device",
    icon: Bluetooth,
  },
  {
    id: "passes",
    label: "Monthly Passes",
    description: "Set pass allowance",
    icon: Ticket,
  },
  {
    id: "timezone",
    label: "Timezone",
    description: "Set your local time",
    icon: Globe,
  },
  {
    id: "system",
    label: "System",
    description: "Restart and version info",
    icon: Settings2,
  },
];

interface SettingsMenuProps {
  onSelectSection: (section: SettingsSection) => void;
}

export function SettingsMenu({ onSelectSection }: SettingsMenuProps) {
  return (
    <div className="space-y-1">
      {menuItems.map((item, index) => (
        <React.Fragment key={item.id}>
          <Button
            variant="ghost"
            className="w-full justify-between h-auto py-4 px-3"
            onClick={() => onSelectSection(item.id)}
          >
            <div className="flex items-center gap-3">
              <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-muted">
                <item.icon className="h-5 w-5 text-muted-foreground" />
              </div>
              <div className="text-left">
                <div className="font-medium">{item.label}</div>
                <div className="text-sm text-muted-foreground">
                  {item.description}
                </div>
              </div>
            </div>
            <ChevronRight className="h-5 w-5 text-muted-foreground" />
          </Button>
          {index < menuItems.length - 1 && <Separator className="my-1" />}
        </React.Fragment>
      ))}
    </div>
  );
}
```

---

## File 3: `/Users/jeffrey/code/tether/web-ui/src/components/settings/WifiSettings.tsx`

```tsx
import * as React from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from "@/components/ui/form";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import {
  Wifi,
  WifiOff,
  Plus,
  Trash2,
  Star,
  StarOff,
  Loader2,
  Eye,
  EyeOff,
} from "lucide-react";
import { useToast } from "@/hooks/use-toast";

// Import generated API client hooks (adjust path based on openapi-ts output)
import {
  useGetWifiNetworks,
  useAddWifiNetwork,
  useDeleteWifiNetwork,
  useSetPrimaryWifiNetwork,
} from "@/client/queries";
import type { WifiNetwork } from "@/client/types";

// Form validation schema for adding a new network
const addNetworkSchema = z.object({
  ssid: z
    .string()
    .min(1, "Network name is required")
    .max(32, "Network name must be 32 characters or less"),
  password: z
    .string()
    .min(8, "Password must be at least 8 characters")
    .max(63, "Password must be 63 characters or less"),
});

type AddNetworkFormValues = z.infer<typeof addNetworkSchema>;

export function WifiSettings() {
  const { toast } = useToast();
  const [showAddForm, setShowAddForm] = React.useState(false);
  const [showPassword, setShowPassword] = React.useState(false);
  const [networkToDelete, setNetworkToDelete] = React.useState<string | null>(
    null
  );

  // Query for current networks
  const {
    data: networks,
    isLoading: isLoadingNetworks,
    error: networksError,
    refetch: refetchNetworks,
  } = useGetWifiNetworks();

  // Mutations
  const addNetworkMutation = useAddWifiNetwork({
    onSuccess: () => {
      toast({
        title: "Network added",
        description: "The Wi-Fi network has been added successfully.",
      });
      form.reset();
      setShowAddForm(false);
      refetchNetworks();
    },
    onError: (error) => {
      toast({
        title: "Failed to add network",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
    },
  });

  const deleteNetworkMutation = useDeleteWifiNetwork({
    onSuccess: () => {
      toast({
        title: "Network removed",
        description: "The Wi-Fi network has been removed.",
      });
      setNetworkToDelete(null);
      refetchNetworks();
    },
    onError: (error) => {
      toast({
        title: "Failed to remove network",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
    },
  });

  const setPrimaryMutation = useSetPrimaryWifiNetwork({
    onSuccess: () => {
      toast({
        title: "Primary network updated",
        description:
          "The primary network has been changed. Please switch to the new network.",
      });
      refetchNetworks();
    },
    onError: (error) => {
      toast({
        title: "Failed to set primary network",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
    },
  });

  // Form setup
  const form = useForm<AddNetworkFormValues>({
    resolver: zodResolver(addNetworkSchema),
    defaultValues: {
      ssid: "",
      password: "",
    },
  });

  const onSubmitAddNetwork = (values: AddNetworkFormValues) => {
    addNetworkMutation.mutate({
      body: {
        ssid: values.ssid,
        password: values.password,
      },
    });
  };

  const handleSetPrimary = (ssid: string) => {
    setPrimaryMutation.mutate({
      body: { ssid },
    });
  };

  const handleDeleteNetwork = (ssid: string) => {
    deleteNetworkMutation.mutate({
      body: { ssid },
    });
  };

  if (isLoadingNetworks) {
    return (
      <div className="flex items-center justify-center py-8">
        <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (networksError) {
    return (
      <div className="text-center py-8">
        <WifiOff className="h-12 w-12 mx-auto text-destructive mb-4" />
        <p className="text-destructive">Failed to load Wi-Fi networks</p>
        <Button variant="outline" className="mt-4" onClick={() => refetchNetworks()}>
          Retry
        </Button>
      </div>
    );
  }

  const networkList = networks?.networks ?? [];

  return (
    <div className="space-y-6">
      {/* Current Networks */}
      <div className="space-y-3">
        <div className="flex items-center justify-between">
          <Label className="text-base font-medium">Saved Networks</Label>
          <Badge variant="secondary">{networkList.length} networks</Badge>
        </div>

        {networkList.length === 0 ? (
          <Card>
            <CardContent className="py-6 text-center">
              <WifiOff className="h-8 w-8 mx-auto text-muted-foreground mb-2" />
              <p className="text-muted-foreground">No networks configured</p>
            </CardContent>
          </Card>
        ) : (
          <div className="space-y-2">
            {networkList.map((network: WifiNetwork) => (
              <Card key={network.ssid}>
                <CardContent className="py-3 px-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <Wifi className="h-5 w-5 text-muted-foreground" />
                      <div>
                        <div className="font-medium flex items-center gap-2">
                          {network.ssid}
                          {network.is_primary && (
                            <Badge variant="default" className="text-xs">
                              Primary
                            </Badge>
                          )}
                          {network.is_connected && (
                            <Badge variant="outline" className="text-xs">
                              Connected
                            </Badge>
                          )}
                        </div>
                      </div>
                    </div>

                    <div className="flex items-center gap-1">
                      {/* Set as Primary Button */}
                      {!network.is_primary && (
                        <Button
                          variant="ghost"
                          size="icon"
                          onClick={() => handleSetPrimary(network.ssid)}
                          disabled={setPrimaryMutation.isPending}
                          title="Set as primary network"
                        >
                          <StarOff className="h-4 w-4" />
                        </Button>
                      )}
                      {network.is_primary && (
                        <Button variant="ghost" size="icon" disabled title="Primary network">
                          <Star className="h-4 w-4 text-yellow-500 fill-yellow-500" />
                        </Button>
                      )}

                      {/* Delete Button */}
                      <AlertDialog
                        open={networkToDelete === network.ssid}
                        onOpenChange={(open) =>
                          setNetworkToDelete(open ? network.ssid : null)
                        }
                      >
                        <AlertDialogTrigger asChild>
                          <Button
                            variant="ghost"
                            size="icon"
                            disabled={network.is_primary || deleteNetworkMutation.isPending}
                            title={
                              network.is_primary
                                ? "Cannot delete primary network"
                                : "Remove network"
                            }
                          >
                            <Trash2 className="h-4 w-4 text-destructive" />
                          </Button>
                        </AlertDialogTrigger>
                        <AlertDialogContent>
                          <AlertDialogHeader>
                            <AlertDialogTitle>Remove Network</AlertDialogTitle>
                            <AlertDialogDescription>
                              Are you sure you want to remove "{network.ssid}"? You
                              will need to add it again to reconnect.
                            </AlertDialogDescription>
                          </AlertDialogHeader>
                          <AlertDialogFooter>
                            <AlertDialogCancel>Cancel</AlertDialogCancel>
                            <AlertDialogAction
                              onClick={() => handleDeleteNetwork(network.ssid)}
                              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                            >
                              {deleteNetworkMutation.isPending ? (
                                <Loader2 className="h-4 w-4 animate-spin" />
                              ) : (
                                "Remove"
                              )}
                            </AlertDialogAction>
                          </AlertDialogFooter>
                        </AlertDialogContent>
                      </AlertDialog>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}
      </div>

      <Separator />

      {/* Add Network Form */}
      {showAddForm ? (
        <Card>
          <CardHeader className="pb-4">
            <CardTitle className="text-base">Add New Network</CardTitle>
          </CardHeader>
          <CardContent>
            <Form {...form}>
              <form
                onSubmit={form.handleSubmit(onSubmitAddNetwork)}
                className="space-y-4"
              >
                <FormField
                  control={form.control}
                  name="ssid"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Network Name (SSID)</FormLabel>
                      <FormControl>
                        <Input
                          placeholder="Enter network name"
                          autoComplete="off"
                          {...field}
                        />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="password"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Password</FormLabel>
                      <FormControl>
                        <div className="relative">
                          <Input
                            type={showPassword ? "text" : "password"}
                            placeholder="Enter password"
                            autoComplete="new-password"
                            {...field}
                          />
                          <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            className="absolute right-0 top-0 h-full px-3"
                            onClick={() => setShowPassword(!showPassword)}
                          >
                            {showPassword ? (
                              <EyeOff className="h-4 w-4" />
                            ) : (
                              <Eye className="h-4 w-4" />
                            )}
                          </Button>
                        </div>
                      </FormControl>
                      <FormDescription>
                        Password must be at least 8 characters
                      </FormDescription>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <div className="flex gap-2 pt-2">
                  <Button
                    type="button"
                    variant="outline"
                    className="flex-1"
                    onClick={() => {
                      setShowAddForm(false);
                      form.reset();
                    }}
                  >
                    Cancel
                  </Button>
                  <Button
                    type="submit"
                    className="flex-1"
                    disabled={addNetworkMutation.isPending}
                  >
                    {addNetworkMutation.isPending ? (
                      <Loader2 className="h-4 w-4 animate-spin mr-2" />
                    ) : null}
                    Add Network
                  </Button>
                </div>
              </form>
            </Form>
          </CardContent>
        </Card>
      ) : (
        <Button
          variant="outline"
          className="w-full"
          onClick={() => setShowAddForm(true)}
        >
          <Plus className="h-4 w-4 mr-2" />
          Add Wi-Fi Network
        </Button>
      )}
    </div>
  );
}
```

---

## File 4: `/Users/jeffrey/code/tether/web-ui/src/components/settings/BluetoothSettings.tsx`

```tsx
import * as React from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Slider } from "@/components/ui/slider";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from "@/components/ui/form";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
  Bluetooth,
  BluetoothSearching,
  BluetoothOff,
  RefreshCw,
  Loader2,
  Signal,
  Check,
} from "lucide-react";
import { useToast } from "@/hooks/use-toast";

// Import generated API client hooks (adjust path based on openapi-ts output)
import {
  useGetBluetoothDevice,
  useGetBluetoothScan,
  useSetBluetoothDevice,
  useUpdateBluetoothThreshold,
} from "@/client/queries";
import type { BluetoothDevice, ScannedDevice } from "@/client/types";

// Threshold form schema
const thresholdSchema = z.object({
  threshold: z.number().min(-100).max(0),
});

type ThresholdFormValues = z.infer<typeof thresholdSchema>;

export function BluetoothSettings() {
  const { toast } = useToast();
  const [isChangingDevice, setIsChangingDevice] = React.useState(false);
  const [isScanning, setIsScanning] = React.useState(false);
  const [selectedDevice, setSelectedDevice] = React.useState<ScannedDevice | null>(
    null
  );
  const [showConfirmChange, setShowConfirmChange] = React.useState(false);

  // Query for current device
  const {
    data: currentDevice,
    isLoading: isLoadingDevice,
    error: deviceError,
    refetch: refetchDevice,
  } = useGetBluetoothDevice();

  // Query for scanning (enabled only when scanning)
  const {
    data: scannedDevices,
    isLoading: isLoadingScan,
    error: scanError,
    refetch: refetchScan,
  } = useGetBluetoothScan({
    enabled: isScanning,
  });

  // Mutations
  const setDeviceMutation = useSetBluetoothDevice({
    onSuccess: () => {
      toast({
        title: "Device updated",
        description: "The Bluetooth device has been changed successfully.",
      });
      setIsChangingDevice(false);
      setSelectedDevice(null);
      setShowConfirmChange(false);
      refetchDevice();
    },
    onError: (error) => {
      toast({
        title: "Failed to update device",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
    },
  });

  const updateThresholdMutation = useUpdateBluetoothThreshold({
    onSuccess: () => {
      toast({
        title: "Threshold updated",
        description: "The proximity threshold has been updated.",
      });
      refetchDevice();
    },
    onError: (error) => {
      toast({
        title: "Failed to update threshold",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
    },
  });

  // Threshold form
  const thresholdForm = useForm<ThresholdFormValues>({
    resolver: zodResolver(thresholdSchema),
    defaultValues: {
      threshold: currentDevice?.threshold ?? -70,
    },
  });

  // Update form when device data loads
  React.useEffect(() => {
    if (currentDevice?.threshold) {
      thresholdForm.setValue("threshold", currentDevice.threshold);
    }
  }, [currentDevice?.threshold, thresholdForm]);

  const handleStartScan = async () => {
    setIsScanning(true);
    await refetchScan();
  };

  const handleRescan = async () => {
    await refetchScan();
  };

  const handleSelectDevice = (device: ScannedDevice) => {
    setSelectedDevice(device);
    setShowConfirmChange(true);
  };

  const handleConfirmDeviceChange = () => {
    if (selectedDevice) {
      setDeviceMutation.mutate({
        body: {
          mac_address: selectedDevice.mac_address,
          name: selectedDevice.name,
        },
      });
    }
  };

  const handleThresholdChange = (value: number[]) => {
    const threshold = value[0];
    thresholdForm.setValue("threshold", threshold);
  };

  const handleThresholdSave = () => {
    const threshold = thresholdForm.getValues("threshold");
    updateThresholdMutation.mutate({
      body: { threshold },
    });
  };

  const getSignalStrengthLabel = (rssi: number): string => {
    if (rssi >= -50) return "Excellent";
    if (rssi >= -60) return "Good";
    if (rssi >= -70) return "Fair";
    return "Weak";
  };

  const getSignalStrengthColor = (rssi: number): string => {
    if (rssi >= -50) return "text-green-500";
    if (rssi >= -60) return "text-lime-500";
    if (rssi >= -70) return "text-yellow-500";
    return "text-red-500";
  };

  if (isLoadingDevice) {
    return (
      <div className="flex items-center justify-center py-8">
        <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (deviceError && !isChangingDevice) {
    return (
      <div className="text-center py-8">
        <BluetoothOff className="h-12 w-12 mx-auto text-destructive mb-4" />
        <p className="text-destructive">Failed to load Bluetooth device</p>
        <Button variant="outline" className="mt-4" onClick={() => refetchDevice()}>
          Retry
        </Button>
      </div>
    );
  }

  // Device change flow (mini-onboarding)
  if (isChangingDevice) {
    return (
      <div className="space-y-6">
        <div className="text-center">
          <BluetoothSearching className="h-12 w-12 mx-auto text-primary mb-4 animate-pulse" />
          <h3 className="font-medium text-lg">Select a Device</h3>
          <p className="text-sm text-muted-foreground mt-1">
            Choose the device you want to track
          </p>
        </div>

        {!isScanning ? (
          <Button className="w-full" onClick={handleStartScan}>
            <BluetoothSearching className="h-4 w-4 mr-2" />
            Start Scanning
          </Button>
        ) : (
          <>
            <div className="flex items-center justify-between">
              <span className="text-sm text-muted-foreground">
                {isLoadingScan ? "Scanning..." : `${scannedDevices?.devices?.length ?? 0} devices found`}
              </span>
              <Button
                variant="outline"
                size="sm"
                onClick={handleRescan}
                disabled={isLoadingScan}
              >
                <RefreshCw
                  className={`h-4 w-4 mr-2 ${isLoadingScan ? "animate-spin" : ""}`}
                />
                Rescan
              </Button>
            </div>

            {scanError ? (
              <Card>
                <CardContent className="py-6 text-center">
                  <BluetoothOff className="h-8 w-8 mx-auto text-destructive mb-2" />
                  <p className="text-destructive">Failed to scan for devices</p>
                </CardContent>
              </Card>
            ) : isLoadingScan ? (
              <div className="space-y-2">
                {[1, 2, 3].map((i) => (
                  <Card key={i} className="animate-pulse">
                    <CardContent className="py-4">
                      <div className="h-5 bg-muted rounded w-1/2" />
                    </CardContent>
                  </Card>
                ))}
              </div>
            ) : (
              <div className="space-y-2 max-h-64 overflow-y-auto">
                {scannedDevices?.devices?.map((device: ScannedDevice) => (
                  <Card
                    key={device.mac_address}
                    className={`cursor-pointer transition-colors hover:bg-accent ${
                      selectedDevice?.mac_address === device.mac_address
                        ? "border-primary"
                        : ""
                    }`}
                    onClick={() => handleSelectDevice(device)}
                  >
                    <CardContent className="py-3 px-4">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <Bluetooth className="h-5 w-5 text-muted-foreground" />
                          <div>
                            <div className="font-medium">
                              {device.name || "Unknown Device"}
                            </div>
                            <div className="text-xs text-muted-foreground">
                              {device.mac_address}
                            </div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <div className={`text-sm ${getSignalStrengthColor(device.rssi)}`}>
                            <Signal className="h-4 w-4 inline mr-1" />
                            {device.rssi} dBm
                          </div>
                          {currentDevice?.mac_address === device.mac_address && (
                            <Badge variant="secondary">Current</Badge>
                          )}
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                ))}

                {scannedDevices?.devices?.length === 0 && (
                  <Card>
                    <CardContent className="py-6 text-center">
                      <p className="text-muted-foreground">
                        No Bluetooth devices found. Make sure your device is nearby
                        and discoverable.
                      </p>
                    </CardContent>
                  </Card>
                )}
              </div>
            )}
          </>
        )}

        <Separator />

        <Button
          variant="outline"
          className="w-full"
          onClick={() => {
            setIsChangingDevice(false);
            setIsScanning(false);
            setSelectedDevice(null);
          }}
        >
          Cancel
        </Button>

        {/* Confirm Device Change Dialog */}
        <AlertDialog open={showConfirmChange} onOpenChange={setShowConfirmChange}>
          <AlertDialogContent>
            <AlertDialogHeader>
              <AlertDialogTitle>Change Tracked Device</AlertDialogTitle>
              <AlertDialogDescription>
                Are you sure you want to track "
                {selectedDevice?.name || selectedDevice?.mac_address}"? This will
                replace the current device.
              </AlertDialogDescription>
            </AlertDialogHeader>
            <AlertDialogFooter>
              <AlertDialogCancel>Cancel</AlertDialogCancel>
              <AlertDialogAction
                onClick={handleConfirmDeviceChange}
                disabled={setDeviceMutation.isPending}
              >
                {setDeviceMutation.isPending ? (
                  <Loader2 className="h-4 w-4 animate-spin mr-2" />
                ) : (
                  <Check className="h-4 w-4 mr-2" />
                )}
                Confirm
              </AlertDialogAction>
            </AlertDialogFooter>
          </AlertDialogContent>
        </AlertDialog>
      </div>
    );
  }

  // Main view - current device
  return (
    <div className="space-y-6">
      {/* Current Device */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Current Device</CardTitle>
        </CardHeader>
        <CardContent>
          {currentDevice ? (
            <div className="space-y-4">
              <div className="flex items-center gap-3">
                <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10">
                  <Bluetooth className="h-6 w-6 text-primary" />
                </div>
                <div>
                  <div className="font-medium">
                    {currentDevice.name || "Unknown Device"}
                  </div>
                  <div className="text-sm text-muted-foreground">
                    {currentDevice.mac_address}
                  </div>
                </div>
              </div>

              {currentDevice.rssi !== undefined && (
                <div className="flex items-center justify-between text-sm">
                  <span className="text-muted-foreground">Signal Strength</span>
                  <span className={getSignalStrengthColor(currentDevice.rssi)}>
                    {currentDevice.rssi} dBm ({getSignalStrengthLabel(currentDevice.rssi)})
                  </span>
                </div>
              )}

              <div className="flex items-center justify-between text-sm">
                <span className="text-muted-foreground">Nearby Status</span>
                <Badge variant={currentDevice.is_nearby ? "default" : "secondary"}>
                  {currentDevice.is_nearby ? "Nearby" : "Not Detected"}
                </Badge>
              </div>
            </div>
          ) : (
            <div className="text-center py-4">
              <BluetoothOff className="h-8 w-8 mx-auto text-muted-foreground mb-2" />
              <p className="text-muted-foreground">No device configured</p>
            </div>
          )}
        </CardContent>
      </Card>

      <Button
        variant="outline"
        className="w-full"
        onClick={() => setIsChangingDevice(true)}
      >
        <RefreshCw className="h-4 w-4 mr-2" />
        Change Device
      </Button>

      <Separator />

      {/* Proximity Threshold */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Proximity Threshold</CardTitle>
        </CardHeader>
        <CardContent>
          <Form {...thresholdForm}>
            <div className="space-y-6">
              <FormField
                control={thresholdForm.control}
                name="threshold"
                render={({ field }) => (
                  <FormItem>
                    <div className="flex justify-between mb-2">
                      <FormLabel>Signal Threshold</FormLabel>
                      <span className="text-sm font-medium">{field.value} dBm</span>
                    </div>
                    <FormControl>
                      <Slider
                        value={[field.value]}
                        onValueChange={handleThresholdChange}
                        min={-100}
                        max={-30}
                        step={5}
                        className="w-full"
                      />
                    </FormControl>
                    <div className="flex justify-between text-xs text-muted-foreground mt-1">
                      <span>Far (-100)</span>
                      <span>Close (-30)</span>
                    </div>
                    <FormDescription className="mt-4">
                      Device will be considered "nearby" when signal strength is
                      above this threshold. A higher value (closer to 0) means the
                      device must be closer.
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <Button
                type="button"
                className="w-full"
                onClick={handleThresholdSave}
                disabled={updateThresholdMutation.isPending}
              >
                {updateThresholdMutation.isPending ? (
                  <Loader2 className="h-4 w-4 animate-spin mr-2" />
                ) : null}
                Save Threshold
              </Button>
            </div>
          </Form>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## File 5: `/Users/jeffrey/code/tether/web-ui/src/components/settings/PassesSettings.tsx`

```tsx
import * as React from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from "@/components/ui/form";
import { Ticket, AlertCircle, Loader2, Info } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

// Import generated API client hooks (adjust path based on openapi-ts output)
import {
  useGetPassesConfig,
  useUpdatePassesConfig,
  useGetPassesRemaining,
} from "@/client/queries";

// Form validation schema
const passesSchema = z.object({
  passesPerMonth: z
    .number()
    .int("Must be a whole number")
    .min(0, "Cannot be negative")
    .max(31, "Cannot exceed 31 passes per month"),
});

type PassesFormValues = z.infer<typeof passesSchema>;

export function PassesSettings() {
  const { toast } = useToast();

  // Query for current config and remaining passes
  const {
    data: passesConfig,
    isLoading: isLoadingConfig,
    error: configError,
    refetch: refetchConfig,
  } = useGetPassesConfig();

  const {
    data: passesRemaining,
    isLoading: isLoadingRemaining,
  } = useGetPassesRemaining();

  // Mutation
  const updatePassesMutation = useUpdatePassesConfig({
    onSuccess: () => {
      toast({
        title: "Passes updated",
        description:
          "Your monthly pass allowance will take effect next month.",
      });
      refetchConfig();
    },
    onError: (error) => {
      toast({
        title: "Failed to update passes",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
    },
  });

  // Form setup
  const form = useForm<PassesFormValues>({
    resolver: zodResolver(passesSchema),
    defaultValues: {
      passesPerMonth: passesConfig?.passes_per_month ?? 3,
    },
  });

  // Update form when config loads
  React.useEffect(() => {
    if (passesConfig?.passes_per_month !== undefined) {
      form.setValue("passesPerMonth", passesConfig.passes_per_month);
    }
  }, [passesConfig?.passes_per_month, form]);

  const onSubmit = (values: PassesFormValues) => {
    updatePassesMutation.mutate({
      body: {
        passes_per_month: values.passesPerMonth,
      },
    });
  };

  // Check if value has changed from saved
  const currentValue = form.watch("passesPerMonth");
  const hasChanges =
    passesConfig?.passes_per_month !== undefined &&
    currentValue !== passesConfig.passes_per_month;

  // Check if there's a pending change for next month
  const hasPendingChange =
    passesConfig?.next_month_passes_per_month !== undefined &&
    passesConfig.next_month_passes_per_month !== passesConfig.passes_per_month;

  if (isLoadingConfig) {
    return (
      <div className="flex items-center justify-center py-8">
        <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (configError) {
    return (
      <div className="text-center py-8">
        <AlertCircle className="h-12 w-12 mx-auto text-destructive mb-4" />
        <p className="text-destructive">Failed to load passes configuration</p>
        <Button variant="outline" className="mt-4" onClick={() => refetchConfig()}>
          Retry
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Current Status */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Current Month</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10">
                <Ticket className="h-6 w-6 text-primary" />
              </div>
              <div>
                <div className="text-2xl font-bold">
                  {isLoadingRemaining ? (
                    <Loader2 className="h-5 w-5 animate-spin" />
                  ) : (
                    passesRemaining?.remaining ?? 0
                  )}
                </div>
                <div className="text-sm text-muted-foreground">
                  passes remaining
                </div>
              </div>
            </div>
            <Badge variant="secondary">
              {passesConfig?.passes_per_month ?? 0} / month
            </Badge>
          </div>
        </CardContent>
      </Card>

      {/* Pending Change Alert */}
      {hasPendingChange && (
        <Alert>
          <Info className="h-4 w-4" />
          <AlertTitle>Pending Change</AlertTitle>
          <AlertDescription>
            Starting next month, you will have{" "}
            <strong>{passesConfig?.next_month_passes_per_month}</strong> passes
            per month.
          </AlertDescription>
        </Alert>
      )}

      {/* Update Form */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Monthly Allowance</CardTitle>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <FormField
                control={form.control}
                name="passesPerMonth"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Passes Per Month</FormLabel>
                    <FormControl>
                      <Input
                        type="number"
                        min={0}
                        max={31}
                        {...field}
                        onChange={(e) =>
                          field.onChange(parseInt(e.target.value, 10) || 0)
                        }
                      />
                    </FormControl>
                    <FormDescription>
                      The number of emergency passes available each month.
                      Passes refresh on the first day of each month.
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <Alert variant="default" className="bg-muted">
                <AlertCircle className="h-4 w-4" />
                <AlertDescription className="text-sm">
                  Changes will take effect on the first day of next month. Your
                  current month's passes will not be affected.
                </AlertDescription>
              </Alert>

              <Button
                type="submit"
                className="w-full"
                disabled={!hasChanges || updatePassesMutation.isPending}
              >
                {updatePassesMutation.isPending ? (
                  <Loader2 className="h-4 w-4 animate-spin mr-2" />
                ) : null}
                {hasChanges ? "Save Changes" : "No Changes"}
              </Button>
            </form>
          </Form>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## File 6: `/Users/jeffrey/code/tether/web-ui/src/components/settings/TimezoneSettings.tsx`

```tsx
import * as React from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
  FormDescription,
} from "@/components/ui/form";
import {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Globe, Loader2, AlertCircle, Clock } from "lucide-react";
import { useToast } from "@/hooks/use-toast";

// Import generated API client hooks (adjust path based on openapi-ts output)
import { useGetTimezone, useUpdateTimezone } from "@/client/queries";

// Grouped timezone list - common IANA timezones
const TIMEZONE_GROUPS: Record<string, { value: string; label: string }[]> = {
  "North America": [
    { value: "America/New_York", label: "Eastern Time (New York)" },
    { value: "America/Chicago", label: "Central Time (Chicago)" },
    { value: "America/Denver", label: "Mountain Time (Denver)" },
    { value: "America/Los_Angeles", label: "Pacific Time (Los Angeles)" },
    { value: "America/Anchorage", label: "Alaska Time (Anchorage)" },
    { value: "Pacific/Honolulu", label: "Hawaii Time (Honolulu)" },
    { value: "America/Phoenix", label: "Arizona (Phoenix)" },
    { value: "America/Toronto", label: "Eastern Time (Toronto)" },
    { value: "America/Vancouver", label: "Pacific Time (Vancouver)" },
  ],
  Europe: [
    { value: "Europe/London", label: "GMT/BST (London)" },
    { value: "Europe/Paris", label: "CET (Paris)" },
    { value: "Europe/Berlin", label: "CET (Berlin)" },
    { value: "Europe/Amsterdam", label: "CET (Amsterdam)" },
    { value: "Europe/Rome", label: "CET (Rome)" },
    { value: "Europe/Madrid", label: "CET (Madrid)" },
    { value: "Europe/Stockholm", label: "CET (Stockholm)" },
    { value: "Europe/Warsaw", label: "CET (Warsaw)" },
    { value: "Europe/Athens", label: "EET (Athens)" },
    { value: "Europe/Moscow", label: "MSK (Moscow)" },
  ],
  "Asia & Pacific": [
    { value: "Asia/Dubai", label: "GST (Dubai)" },
    { value: "Asia/Kolkata", label: "IST (Kolkata)" },
    { value: "Asia/Bangkok", label: "ICT (Bangkok)" },
    { value: "Asia/Singapore", label: "SGT (Singapore)" },
    { value: "Asia/Hong_Kong", label: "HKT (Hong Kong)" },
    { value: "Asia/Shanghai", label: "CST (Shanghai)" },
    { value: "Asia/Tokyo", label: "JST (Tokyo)" },
    { value: "Asia/Seoul", label: "KST (Seoul)" },
    { value: "Australia/Sydney", label: "AEST (Sydney)" },
    { value: "Australia/Melbourne", label: "AEST (Melbourne)" },
    { value: "Australia/Perth", label: "AWST (Perth)" },
    { value: "Pacific/Auckland", label: "NZST (Auckland)" },
  ],
  "South America": [
    { value: "America/Sao_Paulo", label: "BRT (Sao Paulo)" },
    { value: "America/Buenos_Aires", label: "ART (Buenos Aires)" },
    { value: "America/Santiago", label: "CLT (Santiago)" },
    { value: "America/Lima", label: "PET (Lima)" },
    { value: "America/Bogota", label: "COT (Bogota)" },
  ],
  Africa: [
    { value: "Africa/Cairo", label: "EET (Cairo)" },
    { value: "Africa/Johannesburg", label: "SAST (Johannesburg)" },
    { value: "Africa/Lagos", label: "WAT (Lagos)" },
    { value: "Africa/Nairobi", label: "EAT (Nairobi)" },
  ],
  Other: [
    { value: "UTC", label: "UTC" },
    { value: "Etc/GMT+12", label: "GMT-12" },
    { value: "Etc/GMT-12", label: "GMT+12" },
  ],
};

// Form validation schema
const timezoneSchema = z.object({
  timezone: z.string().min(1, "Please select a timezone"),
});

type TimezoneFormValues = z.infer<typeof timezoneSchema>;

// Helper to get current time in a timezone
function getCurrentTimeInTimezone(timezone: string): string {
  try {
    return new Intl.DateTimeFormat("en-US", {
      timeZone: timezone,
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    }).format(new Date());
  } catch {
    return "--:--";
  }
}

// Helper to find timezone label
function getTimezoneLabel(value: string): string {
  for (const group of Object.values(TIMEZONE_GROUPS)) {
    const found = group.find((tz) => tz.value === value);
    if (found) return found.label;
  }
  return value;
}

export function TimezoneSettings() {
  const { toast } = useToast();
  const [currentTime, setCurrentTime] = React.useState<string>("");

  // Query for current timezone
  const {
    data: timezoneData,
    isLoading: isLoadingTimezone,
    error: timezoneError,
    refetch: refetchTimezone,
  } = useGetTimezone();

  // Mutation
  const updateTimezoneMutation = useUpdateTimezone({
    onSuccess: () => {
      toast({
        title: "Timezone updated",
        description: "Your timezone has been saved successfully.",
      });
      refetchTimezone();
    },
    onError: (error) => {
      toast({
        title: "Failed to update timezone",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
    },
  });

  // Form setup
  const form = useForm<TimezoneFormValues>({
    resolver: zodResolver(timezoneSchema),
    defaultValues: {
      timezone: timezoneData?.timezone ?? "",
    },
  });

  const selectedTimezone = form.watch("timezone");

  // Update form when data loads
  React.useEffect(() => {
    if (timezoneData?.timezone) {
      form.setValue("timezone", timezoneData.timezone);
    }
  }, [timezoneData?.timezone, form]);

  // Update current time display
  React.useEffect(() => {
    if (selectedTimezone) {
      const updateTime = () => {
        setCurrentTime(getCurrentTimeInTimezone(selectedTimezone));
      };
      updateTime();
      const interval = setInterval(updateTime, 1000);
      return () => clearInterval(interval);
    }
  }, [selectedTimezone]);

  const onSubmit = (values: TimezoneFormValues) => {
    updateTimezoneMutation.mutate({
      body: {
        timezone: values.timezone,
      },
    });
  };

  // Check if value has changed from saved
  const hasChanges =
    timezoneData?.timezone !== undefined &&
    selectedTimezone !== timezoneData.timezone;

  if (isLoadingTimezone) {
    return (
      <div className="flex items-center justify-center py-8">
        <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (timezoneError) {
    return (
      <div className="text-center py-8">
        <AlertCircle className="h-12 w-12 mx-auto text-destructive mb-4" />
        <p className="text-destructive">Failed to load timezone</p>
        <Button
          variant="outline"
          className="mt-4"
          onClick={() => refetchTimezone()}
        >
          Retry
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Current Time Display */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Current Time</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center gap-3">
            <div className="flex h-12 w-12 items-center justify-center rounded-lg bg-primary/10">
              <Clock className="h-6 w-6 text-primary" />
            </div>
            <div>
              <div className="text-2xl font-bold font-mono">{currentTime}</div>
              <div className="text-sm text-muted-foreground">
                {getTimezoneLabel(selectedTimezone)}
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Timezone Selector */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Select Timezone</CardTitle>
        </CardHeader>
        <CardContent>
          <Form {...form}>
            <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
              <FormField
                control={form.control}
                name="timezone"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Timezone</FormLabel>
                    <Select
                      onValueChange={field.onChange}
                      defaultValue={field.value}
                      value={field.value}
                    >
                      <FormControl>
                        <SelectTrigger>
                          <SelectValue placeholder="Select a timezone">
                            {field.value && (
                              <div className="flex items-center gap-2">
                                <Globe className="h-4 w-4" />
                                {getTimezoneLabel(field.value)}
                              </div>
                            )}
                          </SelectValue>
                        </SelectTrigger>
                      </FormControl>
                      <SelectContent className="max-h-80">
                        {Object.entries(TIMEZONE_GROUPS).map(([group, zones]) => (
                          <SelectGroup key={group}>
                            <SelectLabel>{group}</SelectLabel>
                            {zones.map((tz) => (
                              <SelectItem key={tz.value} value={tz.value}>
                                {tz.label}
                              </SelectItem>
                            ))}
                          </SelectGroup>
                        ))}
                      </SelectContent>
                    </Select>
                    <FormDescription>
                      This timezone is used for determining when monthly passes
                      reset and for displaying times in the dashboard.
                    </FormDescription>
                    <FormMessage />
                  </FormItem>
                )}
              />

              <Button
                type="submit"
                className="w-full"
                disabled={!hasChanges || updateTimezoneMutation.isPending}
              >
                {updateTimezoneMutation.isPending ? (
                  <Loader2 className="h-4 w-4 animate-spin mr-2" />
                ) : null}
                {hasChanges ? "Save Timezone" : "No Changes"}
              </Button>
            </form>
          </Form>
        </CardContent>
      </Card>

      {/* Inferred Timezone Info */}
      {timezoneData?.inferred_timezone &&
        timezoneData.inferred_timezone !== timezoneData.timezone && (
          <Card className="border-dashed">
            <CardContent className="py-4">
              <div className="flex items-start gap-3">
                <Globe className="h-5 w-5 text-muted-foreground mt-0.5" />
                <div>
                  <div className="font-medium text-sm">Detected Timezone</div>
                  <div className="text-sm text-muted-foreground">
                    Based on your network location, you appear to be in{" "}
                    <strong>
                      {getTimezoneLabel(timezoneData.inferred_timezone)}
                    </strong>
                    .
                  </div>
                  <Button
                    variant="link"
                    className="h-auto p-0 mt-1"
                    onClick={() =>
                      form.setValue("timezone", timezoneData.inferred_timezone!)
                    }
                  >
                    Use detected timezone
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        )}
    </div>
  );
}
```

---

## File 7: `/Users/jeffrey/code/tether/web-ui/src/components/settings/SystemSettings.tsx`

```tsx
import * as React from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from "@/components/ui/alert-dialog";
import {
  Power,
  Loader2,
  AlertCircle,
  Info,
  ExternalLink,
  Copy,
  Check,
} from "lucide-react";
import { useToast } from "@/hooks/use-toast";

// Import generated API client hooks (adjust path based on openapi-ts output)
import {
  useGetSystemInfo,
  useRestartSystem,
  useGetDumbpipeTicket,
} from "@/client/queries";

export function SystemSettings() {
  const { toast } = useToast();
  const [showRestartConfirm, setShowRestartConfirm] = React.useState(false);
  const [isRestarting, setIsRestarting] = React.useState(false);
  const [ticketCopied, setTicketCopied] = React.useState(false);

  // Query for system info
  const {
    data: systemInfo,
    isLoading: isLoadingInfo,
    error: infoError,
    refetch: refetchInfo,
  } = useGetSystemInfo();

  // Query for dumbpipe ticket
  const {
    data: ticketData,
    isLoading: isLoadingTicket,
  } = useGetDumbpipeTicket();

  // Mutation
  const restartMutation = useRestartSystem({
    onSuccess: () => {
      setIsRestarting(true);
      toast({
        title: "Restarting...",
        description:
          "The device is restarting. This page will reload when the device is back online.",
      });
      // Poll for device to come back online
      const checkOnline = setInterval(async () => {
        try {
          await refetchInfo();
          clearInterval(checkOnline);
          setIsRestarting(false);
          toast({
            title: "Restart complete",
            description: "The device has restarted successfully.",
          });
        } catch {
          // Still offline, keep polling
        }
      }, 3000);
      // Stop polling after 2 minutes
      setTimeout(() => {
        clearInterval(checkOnline);
        if (isRestarting) {
          setIsRestarting(false);
          toast({
            title: "Restart timeout",
            description:
              "Could not confirm restart. Please check the device manually.",
            variant: "destructive",
          });
        }
      }, 120000);
    },
    onError: (error) => {
      toast({
        title: "Failed to restart",
        description:
          error instanceof Error ? error.message : "An unknown error occurred",
        variant: "destructive",
      });
      setShowRestartConfirm(false);
    },
  });

  const handleRestart = () => {
    restartMutation.mutate({});
    setShowRestartConfirm(false);
  };

  const handleCopyTicket = async () => {
    if (ticketData?.ticket) {
      try {
        await navigator.clipboard.writeText(ticketData.ticket);
        setTicketCopied(true);
        toast({
          title: "Copied",
          description: "Dumbpipe ticket copied to clipboard.",
        });
        setTimeout(() => setTicketCopied(false), 2000);
      } catch {
        toast({
          title: "Failed to copy",
          description: "Could not copy to clipboard.",
          variant: "destructive",
        });
      }
    }
  };

  if (isLoadingInfo) {
    return (
      <div className="flex items-center justify-center py-8">
        <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />
      </div>
    );
  }

  if (infoError) {
    return (
      <div className="text-center py-8">
        <AlertCircle className="h-12 w-12 mx-auto text-destructive mb-4" />
        <p className="text-destructive">Failed to load system information</p>
        <Button variant="outline" className="mt-4" onClick={() => refetchInfo()}>
          Retry
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Device Info */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base">Device Information</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Version</span>
            <Badge variant="secondary">{systemInfo?.version ?? "Unknown"}</Badge>
          </div>
          <Separator />
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Device Model</span>
            <span className="text-sm font-medium">
              {systemInfo?.device_model ?? "Raspberry Pi"}
            </span>
          </div>
          <Separator />
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">Uptime</span>
            <span className="text-sm font-medium">
              {systemInfo?.uptime ?? "Unknown"}
            </span>
          </div>
          {systemInfo?.ip_address && (
            <>
              <Separator />
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">IP Address</span>
                <span className="text-sm font-mono">
                  {systemInfo.ip_address}
                </span>
              </div>
            </>
          )}
        </CardContent>
      </Card>

      {/* Dumbpipe Ticket */}
      <Card>
        <CardHeader className="pb-3">
          <CardTitle className="text-base flex items-center gap-2">
            Remote Access
            <Badge variant="outline" className="font-normal">
              dumbpipe
            </Badge>
          </CardTitle>
        </CardHeader>
        <CardContent>
          {isLoadingTicket ? (
            <div className="flex items-center justify-center py-4">
              <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />
            </div>
          ) : ticketData?.ticket ? (
            <div className="space-y-3">
              <div className="p-3 bg-muted rounded-lg">
                <code className="text-xs break-all font-mono">
                  {ticketData.ticket}
                </code>
              </div>
              <Button
                variant="outline"
                size="sm"
                className="w-full"
                onClick={handleCopyTicket}
              >
                {ticketCopied ? (
                  <>
                    <Check className="h-4 w-4 mr-2" />
                    Copied
                  </>
                ) : (
                  <>
                    <Copy className="h-4 w-4 mr-2" />
                    Copy Ticket
                  </>
                )}
              </Button>
              <p className="text-xs text-muted-foreground">
                Use this ticket to connect to your Tether device remotely via
                the MCP server.
              </p>
            </div>
          ) : (
            <div className="text-center py-4">
              <Info className="h-6 w-6 mx-auto text-muted-foreground mb-2" />
              <p className="text-sm text-muted-foreground">
                Remote access ticket not available.
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* SSH Instructions */}
      <Card className="border-dashed">
        <CardContent className="py-4">
          <div className="flex items-start gap-3">
            <ExternalLink className="h-5 w-5 text-muted-foreground mt-0.5" />
            <div>
              <div className="font-medium text-sm">SSH Access</div>
              <div className="text-sm text-muted-foreground mt-1">
                Connect to view logs and debug:
              </div>
              {systemInfo?.ip_address && (
                <code className="text-xs bg-muted px-2 py-1 rounded mt-2 block">
                  ssh pi@{systemInfo.ip_address}
                </code>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      <Separator />

      {/* Restart Section */}
      <Card className="border-destructive/50">
        <CardHeader className="pb-3">
          <CardTitle className="text-base text-destructive">
            Danger Zone
          </CardTitle>
        </CardHeader>
        <CardContent>
          <AlertDialog
            open={showRestartConfirm}
            onOpenChange={setShowRestartConfirm}
          >
            <AlertDialogTrigger asChild>
              <Button
                variant="destructive"
                className="w-full"
                disabled={isRestarting || restartMutation.isPending}
              >
                {isRestarting ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                    Restarting...
                  </>
                ) : (
                  <>
                    <Power className="h-4 w-4 mr-2" />
                    Restart Device
                  </>
                )}
              </Button>
            </AlertDialogTrigger>
            <AlertDialogContent>
              <AlertDialogHeader>
                <AlertDialogTitle>Restart Device</AlertDialogTitle>
                <AlertDialogDescription>
                  Are you sure you want to restart the Tether device? This will
                  temporarily disconnect all services and may take a few minutes
                  to complete.
                </AlertDialogDescription>
              </AlertDialogHeader>
              <AlertDialogFooter>
                <AlertDialogCancel>Cancel</AlertDialogCancel>
                <AlertDialogAction
                  onClick={handleRestart}
                  className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                  disabled={restartMutation.isPending}
                >
                  {restartMutation.isPending ? (
                    <Loader2 className="h-4 w-4 animate-spin mr-2" />
                  ) : (
                    <Power className="h-4 w-4 mr-2" />
                  )}
                  Restart
                </AlertDialogAction>
              </AlertDialogFooter>
            </AlertDialogContent>
          </AlertDialog>
        </CardContent>
      </Card>
    </div>
  );
}
```

---

## File 8: `/Users/jeffrey/code/tether/web-ui/src/client/queries.ts` (API Hook Stubs)

This file should be generated by openapi-ts, but here are the expected hook signatures for reference:

```tsx
// These hooks will be auto-generated by openapi-ts with @tanstack/react-query plugin
// This file serves as documentation of the expected API

import { useMutation, useQuery, type UseMutationOptions, type UseQueryOptions } from "@tanstack/react-query";

// WiFi Hooks
export function useGetWifiNetworks(options?: UseQueryOptions) {
  // GET /api/wifi/networks
  // Returns: { networks: WifiNetwork[] }
}

export function useAddWifiNetwork(options?: UseMutationOptions) {
  // POST /api/wifi/networks
  // Body: { ssid: string, password: string }
}

export function useDeleteWifiNetwork(options?: UseMutationOptions) {
  // DELETE /api/wifi/networks
  // Body: { ssid: string }
}

export function useSetPrimaryWifiNetwork(options?: UseMutationOptions) {
  // PUT /api/wifi/networks/primary
  // Body: { ssid: string }
}

// Bluetooth Hooks
export function useGetBluetoothDevice(options?: UseQueryOptions) {
  // GET /api/bluetooth/device
  // Returns: BluetoothDevice
}

export function useGetBluetoothScan(options?: UseQueryOptions) {
  // GET /api/bluetooth/scan
  // Returns: { devices: ScannedDevice[] }
}

export function useSetBluetoothDevice(options?: UseMutationOptions) {
  // PUT /api/bluetooth/device
  // Body: { mac_address: string, name?: string }
}

export function useUpdateBluetoothThreshold(options?: UseMutationOptions) {
  // PUT /api/bluetooth/threshold
  // Body: { threshold: number }
}

// Passes Hooks
export function useGetPassesConfig(options?: UseQueryOptions) {
  // GET /api/passes/config
  // Returns: { passes_per_month: number, next_month_passes_per_month?: number }
}

export function useGetPassesRemaining(options?: UseQueryOptions) {
  // GET /api/passes/remaining
  // Returns: { remaining: number }
}

export function useUpdatePassesConfig(options?: UseMutationOptions) {
  // PUT /api/passes/config
  // Body: { passes_per_month: number }
}

// Timezone Hooks
export function useGetTimezone(options?: UseQueryOptions) {
  // GET /api/timezone
  // Returns: { timezone: string, inferred_timezone?: string }
}

export function useUpdateTimezone(options?: UseMutationOptions) {
  // PUT /api/timezone
  // Body: { timezone: string }
}

// System Hooks
export function useGetSystemInfo(options?: UseQueryOptions) {
  // GET /api/system/info
  // Returns: SystemInfo
}

export function useRestartSystem(options?: UseMutationOptions) {
  // POST /api/system/restart
  // Body: {}
}

export function useGetDumbpipeTicket(options?: UseQueryOptions) {
  // GET /api/system/ticket
  // Returns: { ticket: string }
}
```

---

## File 9: `/Users/jeffrey/code/tether/web-ui/src/client/types.ts` (Type Definitions)

```tsx
// These types will be auto-generated by openapi-ts
// This file serves as documentation of the expected types

export interface WifiNetwork {
  ssid: string;
  is_primary: boolean;
  is_connected: boolean;
}

export interface ScannedDevice {
  mac_address: string;
  name: string | null;
  rssi: number;
}

export interface BluetoothDevice {
  mac_address: string;
  name: string | null;
  threshold: number;
  rssi?: number;
  is_nearby: boolean;
}

export interface PassesConfig {
  passes_per_month: number;
  next_month_passes_per_month?: number;
}

export interface PassesRemaining {
  remaining: number;
}

export interface TimezoneConfig {
  timezone: string;
  inferred_timezone?: string;
}

export interface SystemInfo {
  version: string;
  device_model: string;
  uptime: string;
  ip_address?: string;
}

export interface DumbpipeTicket {
  ticket: string;
}
```

---

## File 10: `/Users/jeffrey/code/tether/web-ui/src/hooks/use-toast.ts`

shadcn/ui toast hook - install via `bunx shadcn@latest add toast`:

```tsx
// This file is generated by shadcn/ui
// Run: bunx shadcn@latest add toast
// The hook provides: toast({ title, description, variant })
```

---

## Integration: Using the Settings Drawer

In your main layout or dashboard component:

```tsx
// /Users/jeffrey/code/tether/web-ui/src/components/Dashboard.tsx (or wherever your main view is)

import * as React from "react";
import { Button } from "@/components/ui/button";
import { Settings } from "lucide-react";
import { SettingsDrawer } from "@/components/settings/SettingsDrawer";

export function Dashboard() {
  const [settingsOpen, setSettingsOpen] = React.useState(false);

  return (
    <div>
      {/* Your main dashboard content */}

      {/* Settings trigger button - typically in a bottom tab bar or header */}
      <Button
        variant="ghost"
        size="icon"
        onClick={() => setSettingsOpen(true)}
        aria-label="Open settings"
      >
        <Settings className="h-5 w-5" />
      </Button>

      {/* Settings Drawer */}
      <SettingsDrawer open={settingsOpen} onOpenChange={setSettingsOpen} />
    </div>
  );
}
```

---

## Dependencies and Setup Commands

```bash
# Install shadcn/ui components
bunx shadcn@latest add drawer button form input select label separator alert-dialog card badge toast slider switch alert

# Install form dependencies
bun add react-hook-form zod @hookform/resolvers

# Install icons
bun add lucide-react

# Generate API client (run from project root after OpenAPI spec is available)
bunx @hey-api/openapi-ts \
  --input ../target/openapi.json \
  --output ./src/client \
  --plugins @tanstack/react-query
```

---

## Key Implementation Notes

1. **State Management**: The drawer uses local React state for navigation between sections. When the drawer closes, it resets to the main menu after a brief delay to allow for animation.

2. **API Client Pattern**: All API calls use TanStack Query hooks generated by openapi-ts. The hooks provide:
   - `isLoading` for loading states
   - `error` for error handling
   - `data` for response data
   - `refetch` for manual refetching
   - `isPending` on mutations for submission states

3. **Form Validation**: All forms use Zod schemas with react-hook-form. Validation messages are displayed via `<FormMessage />`.

4. **Toast Notifications**: All mutations show success/error toasts using the shadcn/ui toast component.

5. **Optimistic Updates**: The implementation currently uses refetch after mutations. For better UX, you could implement optimistic updates using TanStack Query's `onMutate` callback.

6. **Responsive Design**: The Drawer component from shadcn/ui is already mobile-optimized with swipe gestures and proper touch handling.

7. **Accessibility**: All interactive elements have proper aria labels, and the drawer manages focus correctly.

---

### Critical Files for Implementation

- `/Users/jeffrey/code/tether/web-ui/src/components/settings/SettingsDrawer.tsx` - Main drawer container with section navigation and back button logic
- `/Users/jeffrey/code/tether/web-ui/src/components/settings/SettingsMenu.tsx` - Settings category list with icons, defines the SettingsSection type
- `/Users/jeffrey/code/tether/web-ui/src/components/settings/WifiSettings.tsx` - Most complex component with CRUD operations for networks, primary network setting
- `/Users/jeffrey/code/tether/web-ui/src/components/settings/BluetoothSettings.tsx` - Device scanning flow (mini-onboarding), threshold slider configuration
- `/Users/jeffrey/code/tether/web-ui/src/client/queries.ts` - Generated API hooks that all settings components depend on (must be generated via openapi-ts)
