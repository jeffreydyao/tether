Now I have a complete understanding of the project. This is a Raspberry Pi-based phone proximity tracker with a React + TypeScript + shadcn/ui web UI. Let me create excruciating implementation details for the onboarding wizard.

---

# Onboarding Wizard Implementation Details

## Overview

This document provides complete, copy-paste ready implementation code for the 6-step onboarding wizard. The wizard guides first-time users through device setup on the Raspberry Pi's temporary WiFi network.

## Prerequisites and Dependencies

Based on the spec, the project uses:
- **Vite + React + TypeScript**
- **shadcn/ui** for components
- **Bun** as package manager
- **openapi-ts** for type-safe API client generation
- **Biome** for linting

Required shadcn/ui components (install via CLI):
```bash
bunx --bun shadcn@latest add button card input label progress slider select drawer sheet badge
```

Additional dependencies:
```bash
bun add @tanstack/react-query lucide-react
```

---

## Type Definitions

Create `/Users/jeffrey/code/tether/web-ui/src/types/onboarding.ts`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/types/onboarding.ts

/**
 * Represents a discovered Bluetooth device from the scan.
 * RSSI values typically range from -100 (weak) to -30 (strong).
 */
export interface BluetoothDevice {
  /** Unique identifier for the device (MAC address or UUID) */
  id: string;
  /** Human-readable device name, may be null for unnamed devices */
  name: string | null;
  /** Received Signal Strength Indicator in dBm */
  rssi: number;
  /** Timestamp of last seen, ISO 8601 format */
  lastSeen: string;
}

/**
 * Response from the Bluetooth scan endpoint.
 */
export interface BluetoothScanResponse {
  devices: BluetoothDevice[];
  /** Whether a scan is currently in progress */
  scanning: boolean;
}

/**
 * Response from the RSSI polling endpoint for a specific device.
 */
export interface DeviceRssiResponse {
  deviceId: string;
  rssi: number;
  /** Whether the device is currently detected */
  connected: boolean;
  timestamp: string;
}

/**
 * WiFi network configuration for submission.
 */
export interface WifiConfig {
  ssid: string;
  password: string;
  /** Whether this is the primary network to connect to after setup */
  isPrimary: boolean;
}

/**
 * Response from WiFi configuration endpoint.
 */
export interface WifiConfigResponse {
  success: boolean;
  /** If failed, contains error message */
  error?: string;
  /** The IP address the device will have on the new network */
  newIpAddress?: string;
}

/**
 * Timezone information.
 */
export interface TimezoneInfo {
  /** IANA timezone identifier (e.g., "America/New_York") */
  id: string;
  /** Display name (e.g., "Eastern Time (US & Canada)") */
  displayName: string;
  /** UTC offset string (e.g., "UTC-05:00") */
  utcOffset: string;
}

/**
 * Complete onboarding configuration to submit on completion.
 */
export interface OnboardingConfig {
  bluetooth: {
    deviceId: string;
    deviceName: string | null;
    signalThreshold: number;
  };
  passes: {
    monthlyCount: number;
  };
  wifi: WifiConfig;
  timezone: string;
}

/**
 * Accumulated data across all wizard steps.
 * Each step populates its relevant section.
 */
export interface WizardStepData {
  bluetooth: {
    selectedDevice: BluetoothDevice | null;
  };
  signalThreshold: {
    threshold: number;
  };
  passes: {
    monthlyCount: number;
  };
  wifi: {
    ssid: string;
    password: string;
  };
  timezone: {
    selected: string;
  };
}

/**
 * Props passed to each wizard step component.
 */
export interface WizardStepProps {
  /** Current accumulated data from all steps */
  data: WizardStepData;
  /** Callback to update step-specific data */
  onDataChange: <K extends keyof WizardStepData>(
    key: K,
    value: Partial<WizardStepData[K]>
  ) => void;
  /** Callback when step is complete and valid */
  onNext: () => void;
  /** Callback to go to previous step (not available on first step) */
  onBack?: () => void;
  /** Whether this step's data is valid and can proceed */
  canProceed: boolean;
  /** Callback to set whether the step can proceed */
  setCanProceed: (canProceed: boolean) => void;
}

/**
 * Wizard step definition for the step registry.
 */
export interface WizardStepDefinition {
  /** Unique step identifier */
  id: string;
  /** Display title for progress bar */
  title: string;
  /** Short description shown in step header */
  description: string;
  /** The step component to render */
  component: React.ComponentType<WizardStepProps>;
  /** Validation function for step data */
  validate: (data: WizardStepData) => boolean;
}

/**
 * Common timezones for quick selection.
 */
export const COMMON_TIMEZONES: TimezoneInfo[] = [
  { id: 'America/New_York', displayName: 'Eastern Time (US & Canada)', utcOffset: 'UTC-05:00' },
  { id: 'America/Chicago', displayName: 'Central Time (US & Canada)', utcOffset: 'UTC-06:00' },
  { id: 'America/Denver', displayName: 'Mountain Time (US & Canada)', utcOffset: 'UTC-07:00' },
  { id: 'America/Los_Angeles', displayName: 'Pacific Time (US & Canada)', utcOffset: 'UTC-08:00' },
  { id: 'America/Anchorage', displayName: 'Alaska', utcOffset: 'UTC-09:00' },
  { id: 'Pacific/Honolulu', displayName: 'Hawaii', utcOffset: 'UTC-10:00' },
  { id: 'Europe/London', displayName: 'London', utcOffset: 'UTC+00:00' },
  { id: 'Europe/Paris', displayName: 'Paris, Berlin, Rome', utcOffset: 'UTC+01:00' },
  { id: 'Europe/Helsinki', displayName: 'Helsinki, Kyiv, Riga', utcOffset: 'UTC+02:00' },
  { id: 'Europe/Moscow', displayName: 'Moscow, St. Petersburg', utcOffset: 'UTC+03:00' },
  { id: 'Asia/Dubai', displayName: 'Dubai, Abu Dhabi', utcOffset: 'UTC+04:00' },
  { id: 'Asia/Kolkata', displayName: 'Mumbai, Kolkata, New Delhi', utcOffset: 'UTC+05:30' },
  { id: 'Asia/Bangkok', displayName: 'Bangkok, Hanoi, Jakarta', utcOffset: 'UTC+07:00' },
  { id: 'Asia/Shanghai', displayName: 'Beijing, Shanghai, Hong Kong', utcOffset: 'UTC+08:00' },
  { id: 'Asia/Tokyo', displayName: 'Tokyo, Seoul', utcOffset: 'UTC+09:00' },
  { id: 'Australia/Sydney', displayName: 'Sydney, Melbourne', utcOffset: 'UTC+10:00' },
  { id: 'Pacific/Auckland', displayName: 'Auckland, Wellington', utcOffset: 'UTC+12:00' },
];

/**
 * Default initial wizard data.
 */
export const DEFAULT_WIZARD_DATA: WizardStepData = {
  bluetooth: {
    selectedDevice: null,
  },
  signalThreshold: {
    threshold: -70, // Reasonable default for "nearby" detection
  },
  passes: {
    monthlyCount: 3, // Sensible default
  },
  wifi: {
    ssid: '',
    password: '',
  },
  timezone: {
    selected: '', // Will be auto-detected
  },
};
```

---

## API Hooks

Create `/Users/jeffrey/code/tether/web-ui/src/hooks/useOnboardingApi.ts`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/hooks/useOnboardingApi.ts

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import type {
  BluetoothScanResponse,
  DeviceRssiResponse,
  WifiConfig,
  WifiConfigResponse,
  OnboardingConfig,
} from '@/types/onboarding';

/**
 * Base API URL - in development this might be proxied,
 * in production it's the same host.
 */
const API_BASE = '/api';

/**
 * Generic fetch wrapper with error handling.
 */
async function apiFetch<T>(
  endpoint: string,
  options?: RequestInit
): Promise<T> {
  const response = await fetch(`${API_BASE}${endpoint}`, {
    headers: {
      'Content-Type': 'application/json',
      ...options?.headers,
    },
    ...options,
  });

  if (!response.ok) {
    const errorBody = await response.text();
    throw new Error(
      `API Error ${response.status}: ${errorBody || response.statusText}`
    );
  }

  return response.json();
}

// ============================================================================
// Bluetooth Scanning
// ============================================================================

/**
 * Hook to trigger a Bluetooth device scan.
 * Returns mutation that can be called to start scanning.
 */
export function useBluetoothScan() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (): Promise<BluetoothScanResponse> => {
      return apiFetch<BluetoothScanResponse>('/bluetooth/scan', {
        method: 'POST',
      });
    },
    onSuccess: () => {
      // Invalidate the devices query to refetch after scan completes
      queryClient.invalidateQueries({ queryKey: ['bluetooth', 'devices'] });
    },
  });
}

/**
 * Hook to get the list of discovered Bluetooth devices.
 * Polls while scanning is in progress.
 */
export function useBluetoothDevices(options?: { enabled?: boolean }) {
  return useQuery({
    queryKey: ['bluetooth', 'devices'],
    queryFn: async (): Promise<BluetoothScanResponse> => {
      return apiFetch<BluetoothScanResponse>('/bluetooth/devices');
    },
    enabled: options?.enabled ?? true,
    // Refetch every 2 seconds while actively scanning
    refetchInterval: (query) => {
      const data = query.state.data;
      return data?.scanning ? 2000 : false;
    },
    staleTime: 5000,
  });
}

// ============================================================================
// RSSI Polling for Signal Threshold Configuration
// ============================================================================

/**
 * Hook to poll RSSI for a specific device.
 * Used during signal threshold configuration step.
 *
 * @param deviceId - The Bluetooth device ID to poll
 * @param options.enabled - Whether polling is active
 * @param options.pollingInterval - Polling interval in ms (default 500)
 */
export function useDeviceRssi(
  deviceId: string | null,
  options?: { enabled?: boolean; pollingInterval?: number }
) {
  const { enabled = true, pollingInterval = 500 } = options ?? {};

  return useQuery({
    queryKey: ['bluetooth', 'rssi', deviceId],
    queryFn: async (): Promise<DeviceRssiResponse> => {
      if (!deviceId) {
        throw new Error('No device ID provided');
      }
      return apiFetch<DeviceRssiResponse>(
        `/bluetooth/devices/${encodeURIComponent(deviceId)}/rssi`
      );
    },
    enabled: enabled && !!deviceId,
    refetchInterval: enabled ? pollingInterval : false,
    // Keep showing last value while refetching
    placeholderData: (previousData) => previousData,
    // Don't retry too aggressively for real-time polling
    retry: 1,
    retryDelay: 100,
  });
}

// ============================================================================
// WiFi Configuration
// ============================================================================

/**
 * Hook to configure WiFi network.
 * This is the critical step that connects to the primary network.
 */
export function useWifiConfig() {
  return useMutation({
    mutationFn: async (config: WifiConfig): Promise<WifiConfigResponse> => {
      return apiFetch<WifiConfigResponse>('/wifi/configure', {
        method: 'POST',
        body: JSON.stringify(config),
      });
    },
  });
}

/**
 * Hook to test WiFi connectivity (dry run).
 * Useful for validating credentials before committing.
 */
export function useWifiTest() {
  return useMutation({
    mutationFn: async (
      config: Omit<WifiConfig, 'isPrimary'>
    ): Promise<{ success: boolean; error?: string }> => {
      return apiFetch('/wifi/test', {
        method: 'POST',
        body: JSON.stringify(config),
      });
    },
  });
}

// ============================================================================
// Timezone
// ============================================================================

/**
 * Hook to get auto-detected timezone based on network location.
 */
export function useDetectedTimezone() {
  return useQuery({
    queryKey: ['timezone', 'detected'],
    queryFn: async (): Promise<{ timezone: string }> => {
      return apiFetch<{ timezone: string }>('/timezone/detect');
    },
    staleTime: Infinity, // Only fetch once
    retry: 2,
  });
}

/**
 * Hook to configure timezone.
 */
export function useTimezoneConfig() {
  return useMutation({
    mutationFn: async (timezone: string): Promise<{ success: boolean }> => {
      return apiFetch('/timezone/configure', {
        method: 'POST',
        body: JSON.stringify({ timezone }),
      });
    },
  });
}

// ============================================================================
// Complete Onboarding
// ============================================================================

/**
 * Hook to submit the complete onboarding configuration.
 * This finalizes setup and transitions to normal operation.
 */
export function useCompleteOnboarding() {
  return useMutation({
    mutationFn: async (
      config: OnboardingConfig
    ): Promise<{
      success: boolean;
      dashboardUrl: string;
      newIpAddress: string;
    }> => {
      return apiFetch('/onboarding/complete', {
        method: 'POST',
        body: JSON.stringify(config),
      });
    },
  });
}

/**
 * Hook to check onboarding status.
 * Used to determine if onboarding is needed.
 */
export function useOnboardingStatus() {
  return useQuery({
    queryKey: ['onboarding', 'status'],
    queryFn: async (): Promise<{
      completed: boolean;
      currentStep?: number;
    }> => {
      return apiFetch('/onboarding/status');
    },
    staleTime: Infinity,
  });
}
```

---

## Main Wizard Component

Create `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/OnboardingWizard.tsx`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/components/onboarding/OnboardingWizard.tsx

import { useState, useCallback, useMemo } from 'react';
import { Progress } from '@/components/ui/progress';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { ChevronLeft } from 'lucide-react';

import type { WizardStepData, WizardStepDefinition } from '@/types/onboarding';
import { DEFAULT_WIZARD_DATA } from '@/types/onboarding';

import { BluetoothScanStep } from './BluetoothScanStep';
import { SignalThresholdStep } from './SignalThresholdStep';
import { PassesConfigStep } from './PassesConfigStep';
import { WifiConfigStep } from './WifiConfigStep';
import { TimezoneStep } from './TimezoneStep';
import { CompletionStep } from './CompletionStep';

/**
 * Step registry defining all wizard steps in order.
 * Each step has validation logic and metadata.
 */
const WIZARD_STEPS: WizardStepDefinition[] = [
  {
    id: 'bluetooth-scan',
    title: 'Find Device',
    description: 'Scan for your phone via Bluetooth',
    component: BluetoothScanStep,
    validate: (data) => data.bluetooth.selectedDevice !== null,
  },
  {
    id: 'signal-threshold',
    title: 'Set Range',
    description: 'Configure proximity detection range',
    component: SignalThresholdStep,
    validate: (data) =>
      data.signalThreshold.threshold >= -100 &&
      data.signalThreshold.threshold <= -30,
  },
  {
    id: 'passes-config',
    title: 'Passes',
    description: 'Set monthly emergency passes',
    component: PassesConfigStep,
    validate: (data) =>
      data.passes.monthlyCount >= 1 && data.passes.monthlyCount <= 10,
  },
  {
    id: 'wifi-config',
    title: 'WiFi',
    description: 'Connect to your home network',
    component: WifiConfigStep,
    validate: (data) =>
      data.wifi.ssid.trim().length > 0 && data.wifi.password.length > 0,
  },
  {
    id: 'timezone',
    title: 'Timezone',
    description: 'Set your local timezone',
    component: TimezoneStep,
    validate: (data) => data.timezone.selected.length > 0,
  },
  {
    id: 'completion',
    title: 'Complete',
    description: 'Setup complete!',
    component: CompletionStep,
    validate: () => true, // Always valid, it's the final step
  },
];

/**
 * Props for the OnboardingWizard component.
 */
interface OnboardingWizardProps {
  /** Callback when onboarding is fully complete */
  onComplete?: () => void;
  /** Initial step index (useful for resuming) */
  initialStep?: number;
  /** Initial data (useful for resuming partially completed wizard) */
  initialData?: Partial<WizardStepData>;
}

/**
 * OnboardingWizard - Main wizard orchestrator component.
 *
 * Manages:
 * - Step state and navigation
 * - Data accumulation across steps
 * - Progress visualization
 * - Step validation
 *
 * Design: Clean, minimal, mobile-first with shadcn/ui components.
 */
export function OnboardingWizard({
  onComplete,
  initialStep = 0,
  initialData,
}: OnboardingWizardProps) {
  // -------------------------------------------------------------------------
  // State Management
  // -------------------------------------------------------------------------

  /** Current step index (0-based) */
  const [currentStep, setCurrentStep] = useState(initialStep);

  /** Accumulated data from all steps */
  const [wizardData, setWizardData] = useState<WizardStepData>(() => ({
    ...DEFAULT_WIZARD_DATA,
    ...initialData,
  }));

  /** Whether current step can proceed (controlled by step component) */
  const [canProceed, setCanProceed] = useState(false);

  // -------------------------------------------------------------------------
  // Derived State
  // -------------------------------------------------------------------------

  /** Current step definition */
  const currentStepDef = WIZARD_STEPS[currentStep];

  /** Progress percentage for progress bar */
  const progressPercent = useMemo(() => {
    // Don't count completion step in progress
    const totalSteps = WIZARD_STEPS.length - 1;
    return Math.round((currentStep / totalSteps) * 100);
  }, [currentStep]);

  /** Whether we're on the first step */
  const isFirstStep = currentStep === 0;

  /** Whether we're on the last step (completion) */
  const isLastStep = currentStep === WIZARD_STEPS.length - 1;

  // -------------------------------------------------------------------------
  // Callbacks
  // -------------------------------------------------------------------------

  /**
   * Update data for a specific step section.
   * Merges partial updates with existing data.
   */
  const handleDataChange = useCallback(
    <K extends keyof WizardStepData>(
      key: K,
      value: Partial<WizardStepData[K]>
    ) => {
      setWizardData((prev) => ({
        ...prev,
        [key]: {
          ...prev[key],
          ...value,
        },
      }));
    },
    []
  );

  /**
   * Navigate to next step.
   * Validates current step before proceeding.
   */
  const handleNext = useCallback(() => {
    // Validate current step
    if (!currentStepDef.validate(wizardData)) {
      console.warn('Step validation failed, cannot proceed');
      return;
    }

    if (isLastStep) {
      // Wizard complete
      onComplete?.();
      return;
    }

    // Move to next step
    setCurrentStep((prev) => prev + 1);
    // Reset canProceed for new step
    setCanProceed(false);
  }, [currentStepDef, wizardData, isLastStep, onComplete]);

  /**
   * Navigate to previous step.
   */
  const handleBack = useCallback(() => {
    if (isFirstStep) return;
    setCurrentStep((prev) => prev - 1);
    // Restore canProceed based on previous step's data
    const prevStep = WIZARD_STEPS[currentStep - 1];
    setCanProceed(prevStep.validate(wizardData));
  }, [isFirstStep, currentStep, wizardData]);

  // -------------------------------------------------------------------------
  // Render
  // -------------------------------------------------------------------------

  const StepComponent = currentStepDef.component;

  return (
    <div className="min-h-screen bg-background flex flex-col">
      {/* Header with progress */}
      <header className="sticky top-0 z-10 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b">
        <div className="container max-w-lg mx-auto px-4 py-4">
          {/* Step indicator */}
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-2">
              {!isFirstStep && !isLastStep && (
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={handleBack}
                  className="h-8 w-8"
                  aria-label="Go back"
                >
                  <ChevronLeft className="h-4 w-4" />
                </Button>
              )}
              <span className="text-sm font-medium text-muted-foreground">
                Step {currentStep + 1} of {WIZARD_STEPS.length}
              </span>
            </div>
            <span className="text-sm font-medium">
              {currentStepDef.title}
            </span>
          </div>

          {/* Progress bar */}
          {!isLastStep && (
            <Progress
              value={progressPercent}
              className="h-1.5"
              aria-label={`Setup progress: ${progressPercent}%`}
            />
          )}
        </div>
      </header>

      {/* Main content area */}
      <main className="flex-1 container max-w-lg mx-auto px-4 py-6">
        <Card className="border-0 shadow-none sm:border sm:shadow-sm">
          <CardHeader className="pb-4">
            <CardTitle className="text-xl">
              {currentStepDef.title}
            </CardTitle>
            <CardDescription>
              {currentStepDef.description}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <StepComponent
              data={wizardData}
              onDataChange={handleDataChange}
              onNext={handleNext}
              onBack={isFirstStep ? undefined : handleBack}
              canProceed={canProceed}
              setCanProceed={setCanProceed}
            />
          </CardContent>
        </Card>
      </main>

      {/* Sticky footer with navigation (mobile-friendly) */}
      {!isLastStep && (
        <footer className="sticky bottom-0 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-t">
          <div className="container max-w-lg mx-auto px-4 py-4">
            <div className="flex gap-3">
              {!isFirstStep && (
                <Button
                  variant="outline"
                  onClick={handleBack}
                  className="flex-1 sm:flex-none"
                >
                  Back
                </Button>
              )}
              <Button
                onClick={handleNext}
                disabled={!canProceed}
                className="flex-1"
              >
                {currentStep === WIZARD_STEPS.length - 2
                  ? 'Complete Setup'
                  : 'Continue'}
              </Button>
            </div>
          </div>
        </footer>
      )}
    </div>
  );
}

export default OnboardingWizard;
```

---

## Step 1: BluetoothScanStep

Create `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/BluetoothScanStep.tsx`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/components/onboarding/BluetoothScanStep.tsx

import { useEffect, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Bluetooth,
  RefreshCw,
  Smartphone,
  Signal,
  SignalLow,
  SignalMedium,
  SignalHigh,
  AlertCircle,
  Loader2,
  Check,
} from 'lucide-react';

import type { WizardStepProps, BluetoothDevice } from '@/types/onboarding';
import { useBluetoothDevices, useBluetoothScan } from '@/hooks/useOnboardingApi';
import { cn } from '@/lib/utils';

/**
 * Get appropriate signal icon based on RSSI value.
 * RSSI ranges: -30 (excellent) to -100 (poor)
 */
function getSignalIcon(rssi: number): React.ComponentType<{ className?: string }> {
  if (rssi >= -50) return SignalHigh;
  if (rssi >= -70) return SignalMedium;
  if (rssi >= -85) return SignalLow;
  return Signal;
}

/**
 * Get signal strength label and color class.
 */
function getSignalInfo(rssi: number): { label: string; colorClass: string } {
  if (rssi >= -50) {
    return { label: 'Excellent', colorClass: 'text-green-600 dark:text-green-400' };
  }
  if (rssi >= -70) {
    return { label: 'Good', colorClass: 'text-emerald-600 dark:text-emerald-400' };
  }
  if (rssi >= -85) {
    return { label: 'Fair', colorClass: 'text-yellow-600 dark:text-yellow-400' };
  }
  return { label: 'Weak', colorClass: 'text-red-600 dark:text-red-400' };
}

/**
 * Props for individual device list item.
 */
interface DeviceListItemProps {
  device: BluetoothDevice;
  isSelected: boolean;
  onSelect: (device: BluetoothDevice) => void;
}

/**
 * Individual device list item component.
 */
function DeviceListItem({ device, isSelected, onSelect }: DeviceListItemProps) {
  const SignalIcon = getSignalIcon(device.rssi);
  const signalInfo = getSignalInfo(device.rssi);

  return (
    <button
      type="button"
      onClick={() => onSelect(device)}
      className={cn(
        'w-full flex items-center gap-3 p-3 rounded-lg border transition-all',
        'hover:bg-accent hover:border-accent-foreground/20',
        'focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2',
        isSelected
          ? 'border-primary bg-primary/5 ring-1 ring-primary'
          : 'border-border bg-card'
      )}
      aria-pressed={isSelected}
      aria-label={`Select ${device.name || 'Unknown device'}`}
    >
      {/* Device icon */}
      <div
        className={cn(
          'flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center',
          isSelected ? 'bg-primary text-primary-foreground' : 'bg-muted'
        )}
      >
        <Smartphone className="h-5 w-5" />
      </div>

      {/* Device info */}
      <div className="flex-1 text-left min-w-0">
        <div className="font-medium truncate">
          {device.name || 'Unknown Device'}
        </div>
        <div className="text-sm text-muted-foreground truncate">
          {device.id}
        </div>
      </div>

      {/* Signal indicator */}
      <div className="flex-shrink-0 flex flex-col items-end gap-0.5">
        <div className="flex items-center gap-1">
          <SignalIcon className={cn('h-4 w-4', signalInfo.colorClass)} />
          <span className={cn('text-sm font-medium', signalInfo.colorClass)}>
            {device.rssi} dBm
          </span>
        </div>
        <span className="text-xs text-muted-foreground">
          {signalInfo.label}
        </span>
      </div>

      {/* Selection indicator */}
      {isSelected && (
        <div className="flex-shrink-0">
          <Check className="h-5 w-5 text-primary" />
        </div>
      )}
    </button>
  );
}

/**
 * BluetoothScanStep - First step of onboarding wizard.
 *
 * Allows user to:
 * 1. Trigger a Bluetooth device scan
 * 2. View discovered devices with signal strength indicators
 * 3. Select their phone from the list
 *
 * Features:
 * - Automatic initial scan on mount
 * - Manual rescan capability
 * - Loading and error states
 * - Signal strength visualization
 * - Selected device persistence
 */
export function BluetoothScanStep({
  data,
  onDataChange,
  setCanProceed,
}: WizardStepProps) {
  // -------------------------------------------------------------------------
  // API Hooks
  // -------------------------------------------------------------------------

  const {
    data: devicesData,
    isLoading: isLoadingDevices,
    error: devicesError,
    refetch: refetchDevices,
  } = useBluetoothDevices();

  const {
    mutate: startScan,
    isPending: isScanning,
    error: scanError,
  } = useBluetoothScan();

  // -------------------------------------------------------------------------
  // Derived State
  // -------------------------------------------------------------------------

  const devices = devicesData?.devices ?? [];
  const isActivelyScanning = devicesData?.scanning ?? false;
  const selectedDevice = data.bluetooth.selectedDevice;
  const error = devicesError || scanError;

  // Sort devices by signal strength (strongest first)
  const sortedDevices = [...devices].sort((a, b) => b.rssi - a.rssi);

  // -------------------------------------------------------------------------
  // Effects
  // -------------------------------------------------------------------------

  // Trigger initial scan on mount
  useEffect(() => {
    if (!devicesData && !isLoadingDevices) {
      startScan();
    }
  }, [devicesData, isLoadingDevices, startScan]);

  // Update canProceed when selection changes
  useEffect(() => {
    setCanProceed(selectedDevice !== null);
  }, [selectedDevice, setCanProceed]);

  // -------------------------------------------------------------------------
  // Handlers
  // -------------------------------------------------------------------------

  const handleDeviceSelect = useCallback(
    (device: BluetoothDevice) => {
      onDataChange('bluetooth', { selectedDevice: device });
    },
    [onDataChange]
  );

  const handleRescan = useCallback(() => {
    startScan();
  }, [startScan]);

  // -------------------------------------------------------------------------
  // Render Helpers
  // -------------------------------------------------------------------------

  const renderContent = () => {
    // Error state
    if (error && !devices.length) {
      return (
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <div className="w-12 h-12 rounded-full bg-destructive/10 flex items-center justify-center mb-4">
            <AlertCircle className="h-6 w-6 text-destructive" />
          </div>
          <h3 className="font-medium mb-1">Scan Failed</h3>
          <p className="text-sm text-muted-foreground mb-4 max-w-xs">
            {error instanceof Error
              ? error.message
              : 'Could not scan for Bluetooth devices. Please try again.'}
          </p>
          <Button onClick={handleRescan} variant="outline" size="sm">
            <RefreshCw className="h-4 w-4 mr-2" />
            Try Again
          </Button>
        </div>
      );
    }

    // Loading/scanning state with no devices yet
    if ((isLoadingDevices || isActivelyScanning) && !devices.length) {
      return (
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <div className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4">
            <Bluetooth className="h-6 w-6 text-primary animate-pulse" />
          </div>
          <h3 className="font-medium mb-1">Scanning for devices...</h3>
          <p className="text-sm text-muted-foreground max-w-xs">
            Make sure your phone's Bluetooth is turned on and discoverable.
          </p>
        </div>
      );
    }

    // No devices found
    if (!devices.length) {
      return (
        <div className="flex flex-col items-center justify-center py-12 text-center">
          <div className="w-12 h-12 rounded-full bg-muted flex items-center justify-center mb-4">
            <Bluetooth className="h-6 w-6 text-muted-foreground" />
          </div>
          <h3 className="font-medium mb-1">No devices found</h3>
          <p className="text-sm text-muted-foreground mb-4 max-w-xs">
            Ensure your phone's Bluetooth is on and visible to other devices.
          </p>
          <Button onClick={handleRescan} variant="outline" size="sm">
            <RefreshCw className="h-4 w-4 mr-2" />
            Scan Again
          </Button>
        </div>
      );
    }

    // Device list
    return (
      <div className="space-y-2">
        {sortedDevices.map((device) => (
          <DeviceListItem
            key={device.id}
            device={device}
            isSelected={selectedDevice?.id === device.id}
            onSelect={handleDeviceSelect}
          />
        ))}
      </div>
    );
  };

  // -------------------------------------------------------------------------
  // Main Render
  // -------------------------------------------------------------------------

  return (
    <div className="space-y-4">
      {/* Instructions */}
      <div className="bg-muted/50 rounded-lg p-3 text-sm">
        <p className="text-muted-foreground">
          Select your phone from the list below. Make sure Bluetooth is enabled
          on your phone and it's set to be discoverable.
        </p>
      </div>

      {/* Rescan button */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          {isActivelyScanning && (
            <Badge variant="secondary" className="gap-1">
              <Loader2 className="h-3 w-3 animate-spin" />
              Scanning
            </Badge>
          )}
          {devices.length > 0 && !isActivelyScanning && (
            <span className="text-sm text-muted-foreground">
              {devices.length} device{devices.length !== 1 ? 's' : ''} found
            </span>
          )}
        </div>
        <Button
          variant="ghost"
          size="sm"
          onClick={handleRescan}
          disabled={isScanning || isActivelyScanning}
        >
          <RefreshCw
            className={cn(
              'h-4 w-4 mr-2',
              (isScanning || isActivelyScanning) && 'animate-spin'
            )}
          />
          Rescan
        </Button>
      </div>

      {/* Device list or states */}
      {renderContent()}

      {/* Selection confirmation */}
      {selectedDevice && (
        <div className="bg-primary/5 border border-primary/20 rounded-lg p-3">
          <div className="flex items-center gap-2">
            <Check className="h-4 w-4 text-primary flex-shrink-0" />
            <p className="text-sm">
              <span className="font-medium">
                {selectedDevice.name || 'Unknown Device'}
              </span>{' '}
              selected. Continue to set up proximity detection.
            </p>
          </div>
        </div>
      )}
    </div>
  );
}

export default BluetoothScanStep;
```

---

## Step 2: SignalThresholdStep

Create `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/SignalThresholdStep.tsx`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/components/onboarding/SignalThresholdStep.tsx

import { useEffect, useMemo, useState } from 'react';
import { Slider } from '@/components/ui/slider';
import { Badge } from '@/components/ui/badge';
import {
  Signal,
  Check,
  X,
  AlertCircle,
  Footprints,
  Loader2,
} from 'lucide-react';

import type { WizardStepProps } from '@/types/onboarding';
import { useDeviceRssi } from '@/hooks/useOnboardingApi';
import { cn } from '@/lib/utils';

/**
 * RSSI value boundaries for the slider.
 * -100 dBm is very weak, -30 dBm is very strong.
 */
const RSSI_MIN = -100;
const RSSI_MAX = -30;

/**
 * Polling interval for RSSI updates in milliseconds.
 */
const POLLING_INTERVAL_MS = 500;

/**
 * Visual indicator for whether device is within threshold.
 */
interface ProximityIndicatorProps {
  currentRssi: number | null;
  threshold: number;
  isLoading: boolean;
  isConnected: boolean;
}

function ProximityIndicator({
  currentRssi,
  threshold,
  isLoading,
  isConnected,
}: ProximityIndicatorProps) {
  const isNearby = currentRssi !== null && currentRssi >= threshold;

  if (isLoading) {
    return (
      <div className="flex flex-col items-center justify-center py-8 text-center">
        <div className="w-20 h-20 rounded-full bg-muted flex items-center justify-center mb-4">
          <Loader2 className="h-10 w-10 text-muted-foreground animate-spin" />
        </div>
        <p className="text-sm text-muted-foreground">
          Connecting to device...
        </p>
      </div>
    );
  }

  if (!isConnected || currentRssi === null) {
    return (
      <div className="flex flex-col items-center justify-center py-8 text-center">
        <div className="w-20 h-20 rounded-full bg-destructive/10 flex items-center justify-center mb-4">
          <AlertCircle className="h-10 w-10 text-destructive" />
        </div>
        <p className="text-sm text-muted-foreground">
          Device not detected. Make sure Bluetooth is on.
        </p>
      </div>
    );
  }

  return (
    <div className="flex flex-col items-center justify-center py-8 text-center">
      <div
        className={cn(
          'w-20 h-20 rounded-full flex items-center justify-center mb-4 transition-all duration-300',
          isNearby
            ? 'bg-green-500/20 ring-4 ring-green-500/30'
            : 'bg-orange-500/20 ring-4 ring-orange-500/30'
        )}
      >
        {isNearby ? (
          <Check className="h-10 w-10 text-green-600 dark:text-green-400" />
        ) : (
          <X className="h-10 w-10 text-orange-600 dark:text-orange-400" />
        )}
      </div>
      <div className="space-y-1">
        <p
          className={cn(
            'font-semibold text-lg',
            isNearby
              ? 'text-green-600 dark:text-green-400'
              : 'text-orange-600 dark:text-orange-400'
          )}
        >
          {isNearby ? 'Nearby' : 'Not Nearby'}
        </p>
        <p className="text-sm text-muted-foreground">
          Current signal: <span className="font-mono">{currentRssi} dBm</span>
        </p>
      </div>
    </div>
  );
}

/**
 * Visual RSSI meter showing current signal strength.
 */
interface RssiMeterProps {
  currentRssi: number | null;
  threshold: number;
}

function RssiMeter({ currentRssi, threshold }: RssiMeterProps) {
  // Normalize RSSI to 0-100 scale for visualization
  const normalizedCurrent = useMemo(() => {
    if (currentRssi === null) return 0;
    const clamped = Math.max(RSSI_MIN, Math.min(RSSI_MAX, currentRssi));
    return ((clamped - RSSI_MIN) / (RSSI_MAX - RSSI_MIN)) * 100;
  }, [currentRssi]);

  const normalizedThreshold = useMemo(() => {
    return ((threshold - RSSI_MIN) / (RSSI_MAX - RSSI_MIN)) * 100;
  }, [threshold]);

  const isNearby = currentRssi !== null && currentRssi >= threshold;

  return (
    <div className="space-y-2">
      {/* Meter bar */}
      <div className="relative h-4 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full overflow-hidden">
        {/* Threshold marker */}
        <div
          className="absolute top-0 bottom-0 w-0.5 bg-foreground z-10"
          style={{ left: `${normalizedThreshold}%` }}
        >
          <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-mono whitespace-nowrap">
            {threshold} dBm
          </div>
        </div>

        {/* Current value marker */}
        {currentRssi !== null && (
          <div
            className={cn(
              'absolute top-0 bottom-0 w-1 rounded-full transition-all duration-300',
              isNearby ? 'bg-green-900' : 'bg-orange-900'
            )}
            style={{ left: `${normalizedCurrent}%` }}
          >
            <div
              className={cn(
                'absolute -bottom-6 left-1/2 -translate-x-1/2 text-xs font-mono font-bold whitespace-nowrap',
                isNearby ? 'text-green-600' : 'text-orange-600'
              )}
            >
              {currentRssi} dBm
            </div>
          </div>
        )}
      </div>

      {/* Labels */}
      <div className="flex justify-between text-xs text-muted-foreground pt-4">
        <span>Weak ({RSSI_MIN})</span>
        <span>Strong ({RSSI_MAX})</span>
      </div>
    </div>
  );
}

/**
 * RSSI history tracker for smoothing display.
 * Keeps last N readings for averaging.
 */
function useRssiHistory(currentRssi: number | null, maxSize = 5) {
  const [history, setHistory] = useState<number[]>([]);

  useEffect(() => {
    if (currentRssi === null) return;

    setHistory((prev) => {
      const updated = [...prev, currentRssi];
      return updated.slice(-maxSize);
    });
  }, [currentRssi, maxSize]);

  const average = useMemo(() => {
    if (history.length === 0) return null;
    return Math.round(history.reduce((a, b) => a + b, 0) / history.length);
  }, [history]);

  return { history, average };
}

/**
 * SignalThresholdStep - Second step of onboarding wizard.
 *
 * Allows user to:
 * 1. See real-time RSSI signal strength of their selected device
 * 2. Adjust the threshold slider to define "nearby"
 * 3. Walk around to understand signal variation
 *
 * Features:
 * - Real-time polling every 500ms
 * - Visual proximity indicator
 * - Signal strength meter
 * - Instructions for calibration
 */
export function SignalThresholdStep({
  data,
  onDataChange,
  setCanProceed,
}: WizardStepProps) {
  // -------------------------------------------------------------------------
  // State & Data
  // -------------------------------------------------------------------------

  const selectedDevice = data.bluetooth.selectedDevice;
  const threshold = data.signalThreshold.threshold;

  // Poll RSSI for selected device
  const {
    data: rssiData,
    isLoading: isLoadingRssi,
    error: rssiError,
  } = useDeviceRssi(selectedDevice?.id ?? null, {
    enabled: !!selectedDevice,
    pollingInterval: POLLING_INTERVAL_MS,
  });

  const currentRssi = rssiData?.rssi ?? null;
  const isConnected = rssiData?.connected ?? false;

  // Use smoothed average for display
  const { average: smoothedRssi } = useRssiHistory(currentRssi);

  // -------------------------------------------------------------------------
  // Effects
  // -------------------------------------------------------------------------

  // Always allow proceeding since we have a default threshold
  useEffect(() => {
    setCanProceed(true);
  }, [setCanProceed]);

  // -------------------------------------------------------------------------
  // Handlers
  // -------------------------------------------------------------------------

  const handleThresholdChange = (values: number[]) => {
    const newThreshold = values[0];
    onDataChange('signalThreshold', { threshold: newThreshold });
  };

  // -------------------------------------------------------------------------
  // Render
  // -------------------------------------------------------------------------

  if (!selectedDevice) {
    return (
      <div className="flex flex-col items-center justify-center py-12 text-center">
        <AlertCircle className="h-12 w-12 text-destructive mb-4" />
        <p className="text-muted-foreground">
          No device selected. Please go back and select a device.
        </p>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Selected device info */}
      <div className="flex items-center gap-3 p-3 bg-muted/50 rounded-lg">
        <Signal className="h-5 w-5 text-muted-foreground flex-shrink-0" />
        <div className="min-w-0">
          <p className="font-medium truncate">
            {selectedDevice.name || 'Unknown Device'}
          </p>
          <p className="text-sm text-muted-foreground truncate">
            {selectedDevice.id}
          </p>
        </div>
        {rssiData && (
          <Badge variant="outline" className="flex-shrink-0 ml-auto">
            Live
          </Badge>
        )}
      </div>

      {/* Proximity indicator */}
      <ProximityIndicator
        currentRssi={smoothedRssi}
        threshold={threshold}
        isLoading={isLoadingRssi && !rssiData}
        isConnected={isConnected}
      />

      {/* RSSI Meter */}
      <div className="py-4">
        <RssiMeter currentRssi={smoothedRssi} threshold={threshold} />
      </div>

      {/* Threshold slider */}
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <label className="text-sm font-medium">
            Proximity Threshold
          </label>
          <span className="text-sm text-muted-foreground font-mono">
            {threshold} dBm
          </span>
        </div>

        <Slider
          value={[threshold]}
          onValueChange={handleThresholdChange}
          min={RSSI_MIN}
          max={RSSI_MAX}
          step={1}
          className="py-2"
          aria-label="Signal threshold"
        />

        <div className="flex justify-between text-xs text-muted-foreground">
          <span>Farther away</span>
          <span>Closer required</span>
        </div>
      </div>

      {/* Instructions */}
      <div className="bg-muted/50 rounded-lg p-4 space-y-3">
        <div className="flex items-start gap-3">
          <Footprints className="h-5 w-5 text-muted-foreground flex-shrink-0 mt-0.5" />
          <div className="space-y-2 text-sm">
            <p className="font-medium">Calibration tips:</p>
            <ol className="list-decimal list-inside space-y-1 text-muted-foreground">
              <li>
                Place your phone where you want it to be detected as "nearby"
              </li>
              <li>
                Note the signal strength shown above
              </li>
              <li>
                Walk to where you want it to be "not nearby" and check the reading
              </li>
              <li>
                Set the threshold between these two values
              </li>
            </ol>
          </div>
        </div>
      </div>

      {/* Error display */}
      {rssiError && (
        <div className="bg-destructive/10 text-destructive rounded-lg p-3 text-sm">
          <div className="flex items-center gap-2">
            <AlertCircle className="h-4 w-4 flex-shrink-0" />
            <p>
              {rssiError instanceof Error
                ? rssiError.message
                : 'Error reading signal strength'}
            </p>
          </div>
        </div>
      )}
    </div>
  );
}

export default SignalThresholdStep;
```

---

## Step 3: PassesConfigStep

Create `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/PassesConfigStep.tsx`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/components/onboarding/PassesConfigStep.tsx

import { useEffect, useCallback } from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Minus, Plus, Ticket, Info } from 'lucide-react';

import type { WizardStepProps } from '@/types/onboarding';
import { cn } from '@/lib/utils';

/**
 * Minimum and maximum allowed passes per month.
 */
const MIN_PASSES = 1;
const MAX_PASSES = 10;

/**
 * PassesConfigStep - Third step of onboarding wizard.
 *
 * Allows user to configure the number of emergency passes
 * available each month for keeping their phone with them.
 *
 * Features:
 * - Numeric input with increment/decrement buttons
 * - Clear explanation of what passes do
 * - Validation within 1-10 range
 */
export function PassesConfigStep({
  data,
  onDataChange,
  setCanProceed,
}: WizardStepProps) {
  const passCount = data.passes.monthlyCount;

  // -------------------------------------------------------------------------
  // Effects
  // -------------------------------------------------------------------------

  // Validate and update canProceed
  useEffect(() => {
    const isValid = passCount >= MIN_PASSES && passCount <= MAX_PASSES;
    setCanProceed(isValid);
  }, [passCount, setCanProceed]);

  // -------------------------------------------------------------------------
  // Handlers
  // -------------------------------------------------------------------------

  const handleIncrement = useCallback(() => {
    if (passCount < MAX_PASSES) {
      onDataChange('passes', { monthlyCount: passCount + 1 });
    }
  }, [passCount, onDataChange]);

  const handleDecrement = useCallback(() => {
    if (passCount > MIN_PASSES) {
      onDataChange('passes', { monthlyCount: passCount - 1 });
    }
  }, [passCount, onDataChange]);

  const handleInputChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const value = e.target.value;

      // Allow empty string for typing
      if (value === '') {
        onDataChange('passes', { monthlyCount: MIN_PASSES });
        return;
      }

      const parsed = parseInt(value, 10);
      if (!isNaN(parsed)) {
        // Clamp to valid range
        const clamped = Math.max(MIN_PASSES, Math.min(MAX_PASSES, parsed));
        onDataChange('passes', { monthlyCount: clamped });
      }
    },
    [onDataChange]
  );

  // -------------------------------------------------------------------------
  // Render
  // -------------------------------------------------------------------------

  return (
    <div className="space-y-6">
      {/* Explanation card */}
      <div className="bg-muted/50 rounded-lg p-4 space-y-3">
        <div className="flex items-start gap-3">
          <Ticket className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
          <div className="space-y-2">
            <p className="font-medium">What are passes?</p>
            <p className="text-sm text-muted-foreground">
              Sometimes you need to keep your phone with you at night - maybe
              you're traveling, expecting an important call, or there's an
              emergency.
            </p>
            <p className="text-sm text-muted-foreground">
              Passes let you temporarily bypass the proximity check. When you
              use a pass, you'll provide a reason that's logged for your
              records.
            </p>
          </div>
        </div>
      </div>

      {/* Pass count input */}
      <div className="space-y-3">
        <Label htmlFor="pass-count" className="text-base font-medium">
          Passes per month
        </Label>

        <div className="flex items-center gap-3">
          {/* Decrement button */}
          <Button
            type="button"
            variant="outline"
            size="icon"
            onClick={handleDecrement}
            disabled={passCount <= MIN_PASSES}
            aria-label="Decrease pass count"
            className="h-12 w-12"
          >
            <Minus className="h-4 w-4" />
          </Button>

          {/* Number input */}
          <div className="relative flex-1">
            <Input
              id="pass-count"
              type="number"
              min={MIN_PASSES}
              max={MAX_PASSES}
              value={passCount}
              onChange={handleInputChange}
              className={cn(
                'text-center text-2xl font-semibold h-12',
                '[appearance:textfield]',
                '[&::-webkit-outer-spin-button]:appearance-none',
                '[&::-webkit-inner-spin-button]:appearance-none'
              )}
              aria-describedby="pass-count-description"
            />
          </div>

          {/* Increment button */}
          <Button
            type="button"
            variant="outline"
            size="icon"
            onClick={handleIncrement}
            disabled={passCount >= MAX_PASSES}
            aria-label="Increase pass count"
            className="h-12 w-12"
          >
            <Plus className="h-4 w-4" />
          </Button>
        </div>

        <p
          id="pass-count-description"
          className="text-sm text-muted-foreground text-center"
        >
          {passCount === 1 ? '1 pass' : `${passCount} passes`} available each
          month
        </p>
      </div>

      {/* Quick selection buttons */}
      <div className="space-y-2">
        <p className="text-sm text-muted-foreground">Quick select:</p>
        <div className="flex flex-wrap gap-2">
          {[1, 2, 3, 5, 7, 10].map((count) => (
            <Button
              key={count}
              type="button"
              variant={passCount === count ? 'default' : 'outline'}
              size="sm"
              onClick={() => onDataChange('passes', { monthlyCount: count })}
              className="min-w-[3rem]"
            >
              {count}
            </Button>
          ))}
        </div>
      </div>

      {/* Additional info */}
      <div className="flex items-start gap-2 text-sm text-muted-foreground">
        <Info className="h-4 w-4 flex-shrink-0 mt-0.5" />
        <p>
          Unused passes don't roll over. Passes reset on the first day of each
          month. You can change this setting later, but changes take effect the
          following month.
        </p>
      </div>
    </div>
  );
}

export default PassesConfigStep;
```

---

## Step 4: WifiConfigStep

Create `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/WifiConfigStep.tsx`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/components/onboarding/WifiConfigStep.tsx

import { useEffect, useState, useCallback } from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import {
  Wifi,
  Eye,
  EyeOff,
  AlertCircle,
  Loader2,
  CheckCircle2,
} from 'lucide-react';

import type { WizardStepProps } from '@/types/onboarding';
import { useWifiTest } from '@/hooks/useOnboardingApi';
import { cn } from '@/lib/utils';

/**
 * WifiConfigStep - Fourth step of onboarding wizard.
 *
 * Allows user to configure the primary WiFi network
 * that the Raspberry Pi will connect to after setup.
 *
 * Features:
 * - SSID input
 * - Password input with show/hide toggle
 * - Optional connection test
 * - Form validation
 */
export function WifiConfigStep({
  data,
  onDataChange,
  setCanProceed,
}: WizardStepProps) {
  const { ssid, password } = data.wifi;

  // Local state for password visibility
  const [showPassword, setShowPassword] = useState(false);

  // Local state for test result
  const [testResult, setTestResult] = useState<{
    success: boolean;
    message: string;
  } | null>(null);

  // WiFi test mutation
  const {
    mutate: testConnection,
    isPending: isTesting,
    reset: resetTest,
  } = useWifiTest();

  // -------------------------------------------------------------------------
  // Effects
  // -------------------------------------------------------------------------

  // Validate form and update canProceed
  useEffect(() => {
    const isValid = ssid.trim().length > 0 && password.length > 0;
    setCanProceed(isValid);
  }, [ssid, password, setCanProceed]);

  // Reset test result when inputs change
  useEffect(() => {
    if (testResult) {
      setTestResult(null);
      resetTest();
    }
  }, [ssid, password]); // eslint-disable-line react-hooks/exhaustive-deps

  // -------------------------------------------------------------------------
  // Handlers
  // -------------------------------------------------------------------------

  const handleSsidChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      onDataChange('wifi', { ssid: e.target.value });
    },
    [onDataChange]
  );

  const handlePasswordChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      onDataChange('wifi', { password: e.target.value });
    },
    [onDataChange]
  );

  const togglePasswordVisibility = useCallback(() => {
    setShowPassword((prev) => !prev);
  }, []);

  const handleTestConnection = useCallback(() => {
    if (!ssid.trim() || !password) return;

    testConnection(
      { ssid: ssid.trim(), password },
      {
        onSuccess: (result) => {
          setTestResult({
            success: result.success,
            message: result.success
              ? 'Connection test successful!'
              : result.error || 'Connection test failed',
          });
        },
        onError: (error) => {
          setTestResult({
            success: false,
            message:
              error instanceof Error
                ? error.message
                : 'Failed to test connection',
          });
        },
      }
    );
  }, [ssid, password, testConnection]);

  // -------------------------------------------------------------------------
  // Render
  // -------------------------------------------------------------------------

  const canTest = ssid.trim().length > 0 && password.length > 0;

  return (
    <div className="space-y-6">
      {/* Info banner */}
      <div className="bg-muted/50 rounded-lg p-4">
        <div className="flex items-start gap-3">
          <Wifi className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
          <div className="space-y-1">
            <p className="font-medium">Primary WiFi Network</p>
            <p className="text-sm text-muted-foreground">
              Enter the WiFi network tether should connect to after setup. This
              should be your home network where the device will be used.
            </p>
          </div>
        </div>
      </div>

      {/* Form fields */}
      <div className="space-y-4">
        {/* SSID field */}
        <div className="space-y-2">
          <Label htmlFor="wifi-ssid">Network Name (SSID)</Label>
          <Input
            id="wifi-ssid"
            type="text"
            value={ssid}
            onChange={handleSsidChange}
            placeholder="Enter your WiFi network name"
            autoComplete="off"
            autoCapitalize="off"
            spellCheck={false}
          />
        </div>

        {/* Password field */}
        <div className="space-y-2">
          <Label htmlFor="wifi-password">Password</Label>
          <div className="relative">
            <Input
              id="wifi-password"
              type={showPassword ? 'text' : 'password'}
              value={password}
              onChange={handlePasswordChange}
              placeholder="Enter your WiFi password"
              autoComplete="off"
              className="pr-10"
            />
            <Button
              type="button"
              variant="ghost"
              size="icon"
              className="absolute right-0 top-0 h-full px-3 hover:bg-transparent"
              onClick={togglePasswordVisibility}
              aria-label={showPassword ? 'Hide password' : 'Show password'}
            >
              {showPassword ? (
                <EyeOff className="h-4 w-4 text-muted-foreground" />
              ) : (
                <Eye className="h-4 w-4 text-muted-foreground" />
              )}
            </Button>
          </div>
        </div>
      </div>

      {/* Test connection button */}
      <div className="space-y-3">
        <Button
          type="button"
          variant="outline"
          onClick={handleTestConnection}
          disabled={!canTest || isTesting}
          className="w-full"
        >
          {isTesting ? (
            <>
              <Loader2 className="h-4 w-4 mr-2 animate-spin" />
              Testing connection...
            </>
          ) : (
            <>
              <Wifi className="h-4 w-4 mr-2" />
              Test Connection (Optional)
            </>
          )}
        </Button>

        {/* Test result */}
        {testResult && (
          <div
            className={cn(
              'rounded-lg p-3 text-sm',
              testResult.success
                ? 'bg-green-500/10 text-green-700 dark:text-green-400'
                : 'bg-destructive/10 text-destructive'
            )}
          >
            <div className="flex items-center gap-2">
              {testResult.success ? (
                <CheckCircle2 className="h-4 w-4 flex-shrink-0" />
              ) : (
                <AlertCircle className="h-4 w-4 flex-shrink-0" />
              )}
              <p>{testResult.message}</p>
            </div>
          </div>
        )}
      </div>

      {/* Important note */}
      <div className="flex items-start gap-2 text-sm text-muted-foreground">
        <AlertCircle className="h-4 w-4 flex-shrink-0 mt-0.5" />
        <p>
          After completing setup, the device will disconnect from this
          temporary network and connect to your configured WiFi. You'll need to
          switch back to your home network to access the dashboard.
        </p>
      </div>
    </div>
  );
}

export default WifiConfigStep;
```

---

## Step 5: TimezoneStep

Create `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/TimezoneStep.tsx`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/components/onboarding/TimezoneStep.tsx

import { useEffect, useState, useMemo, useCallback } from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Clock,
  MapPin,
  Loader2,
  Check,
  Search,
  RefreshCw,
} from 'lucide-react';

import type { WizardStepProps, TimezoneInfo } from '@/types/onboarding';
import { COMMON_TIMEZONES } from '@/types/onboarding';
import { useDetectedTimezone } from '@/hooks/useOnboardingApi';
import { cn } from '@/lib/utils';

/**
 * Get all IANA timezone identifiers from the browser.
 * Falls back to common timezones if Intl API unavailable.
 */
function getAllTimezones(): string[] {
  try {
    // Modern browsers support this
    // @ts-expect-error - supportedValuesOf may not be in types yet
    if (Intl.supportedValuesOf) {
      // @ts-expect-error
      return Intl.supportedValuesOf('timeZone');
    }
  } catch {
    // Fall back to common timezones
  }
  return COMMON_TIMEZONES.map((tz) => tz.id);
}

/**
 * Format timezone for display.
 */
function formatTimezone(tzId: string): string {
  try {
    const now = new Date();
    const formatter = new Intl.DateTimeFormat('en-US', {
      timeZone: tzId,
      timeZoneName: 'longOffset',
    });
    const parts = formatter.formatToParts(now);
    const offsetPart = parts.find((p) => p.type === 'timeZoneName');
    const offset = offsetPart?.value || '';

    // Convert "America/New_York" to "New York"
    const name = tzId.split('/').pop()?.replace(/_/g, ' ') || tzId;

    return `${name} (${offset})`;
  } catch {
    return tzId;
  }
}

/**
 * Get current time in a specific timezone.
 */
function getCurrentTimeInZone(tzId: string): string {
  try {
    return new Intl.DateTimeFormat('en-US', {
      timeZone: tzId,
      hour: 'numeric',
      minute: '2-digit',
      hour12: true,
    }).format(new Date());
  } catch {
    return '--:--';
  }
}

/**
 * TimezoneStep - Fifth step of onboarding wizard.
 *
 * Allows user to configure their timezone for pass resets
 * and logging purposes.
 *
 * Features:
 * - Auto-detection from network/browser
 * - Searchable timezone list
 * - Common timezone quick select
 * - Current time preview
 */
export function TimezoneStep({
  data,
  onDataChange,
  setCanProceed,
}: WizardStepProps) {
  const selectedTimezone = data.timezone.selected;

  // Local state
  const [searchQuery, setSearchQuery] = useState('');
  const [showAll, setShowAll] = useState(false);

  // Auto-detect timezone from backend
  const {
    data: detectedData,
    isLoading: isDetecting,
    refetch: retryDetection,
  } = useDetectedTimezone();

  // All available timezones
  const allTimezones = useMemo(() => getAllTimezones(), []);

  // Browser's detected timezone (client-side)
  const browserTimezone = useMemo(() => {
    try {
      return Intl.DateTimeFormat().resolvedOptions().timeZone;
    } catch {
      return null;
    }
  }, []);

  // Effective detected timezone (prefer server, fall back to browser)
  const detectedTimezone = detectedData?.timezone || browserTimezone;

  // Filtered timezones based on search
  const filteredTimezones = useMemo(() => {
    if (!searchQuery.trim()) {
      return showAll ? allTimezones : COMMON_TIMEZONES.map((tz) => tz.id);
    }

    const query = searchQuery.toLowerCase();
    return allTimezones.filter(
      (tz) =>
        tz.toLowerCase().includes(query) ||
        formatTimezone(tz).toLowerCase().includes(query)
    );
  }, [searchQuery, showAll, allTimezones]);

  // Current time in selected timezone
  const currentTime = useMemo(() => {
    if (!selectedTimezone) return null;
    return getCurrentTimeInZone(selectedTimezone);
  }, [selectedTimezone]);

  // -------------------------------------------------------------------------
  // Effects
  // -------------------------------------------------------------------------

  // Auto-select detected timezone on first load
  useEffect(() => {
    if (!selectedTimezone && detectedTimezone) {
      onDataChange('timezone', { selected: detectedTimezone });
    }
  }, [detectedTimezone, selectedTimezone, onDataChange]);

  // Validate selection
  useEffect(() => {
    setCanProceed(selectedTimezone.length > 0);
  }, [selectedTimezone, setCanProceed]);

  // -------------------------------------------------------------------------
  // Handlers
  // -------------------------------------------------------------------------

  const handleTimezoneSelect = useCallback(
    (tzId: string) => {
      onDataChange('timezone', { selected: tzId });
      setSearchQuery('');
    },
    [onDataChange]
  );

  const handleSearchChange = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      setSearchQuery(e.target.value);
    },
    []
  );

  const handleUseDetected = useCallback(() => {
    if (detectedTimezone) {
      onDataChange('timezone', { selected: detectedTimezone });
    }
  }, [detectedTimezone, onDataChange]);

  // -------------------------------------------------------------------------
  // Render
  // -------------------------------------------------------------------------

  return (
    <div className="space-y-6">
      {/* Auto-detected timezone banner */}
      {detectedTimezone && (
        <div className="bg-muted/50 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <MapPin className="h-5 w-5 text-primary flex-shrink-0 mt-0.5" />
            <div className="flex-1 min-w-0 space-y-2">
              <div className="flex items-center gap-2 flex-wrap">
                <p className="font-medium">Detected timezone</p>
                {isDetecting && (
                  <Loader2 className="h-4 w-4 animate-spin text-muted-foreground" />
                )}
              </div>
              <p className="text-sm text-muted-foreground truncate">
                {formatTimezone(detectedTimezone)}
              </p>
              {selectedTimezone !== detectedTimezone && (
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={handleUseDetected}
                  className="mt-1"
                >
                  Use detected timezone
                </Button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* Current selection */}
      {selectedTimezone && (
        <div className="flex items-center justify-between p-3 border rounded-lg">
          <div className="flex items-center gap-3">
            <Clock className="h-5 w-5 text-muted-foreground" />
            <div>
              <p className="font-medium">{formatTimezone(selectedTimezone)}</p>
              <p className="text-sm text-muted-foreground">
                Current time: {currentTime}
              </p>
            </div>
          </div>
          {selectedTimezone === detectedTimezone && (
            <Badge variant="secondary">Detected</Badge>
          )}
        </div>
      )}

      {/* Timezone search/select */}
      <div className="space-y-3">
        <Label>Select timezone</Label>

        {/* Search input */}
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            type="text"
            placeholder="Search timezones..."
            value={searchQuery}
            onChange={handleSearchChange}
            className="pl-9"
          />
        </div>

        {/* Quick select for common timezones */}
        {!searchQuery && !showAll && (
          <div className="space-y-2">
            <div className="grid gap-2 max-h-48 overflow-y-auto">
              {COMMON_TIMEZONES.map((tz) => (
                <button
                  key={tz.id}
                  type="button"
                  onClick={() => handleTimezoneSelect(tz.id)}
                  className={cn(
                    'flex items-center justify-between p-2 rounded-lg border text-left transition-colors',
                    'hover:bg-accent hover:border-accent-foreground/20',
                    selectedTimezone === tz.id
                      ? 'border-primary bg-primary/5'
                      : 'border-border'
                  )}
                >
                  <div className="min-w-0">
                    <p className="font-medium text-sm truncate">
                      {tz.displayName}
                    </p>
                    <p className="text-xs text-muted-foreground">
                      {tz.utcOffset}
                    </p>
                  </div>
                  {selectedTimezone === tz.id && (
                    <Check className="h-4 w-4 text-primary flex-shrink-0" />
                  )}
                </button>
              ))}
            </div>

            <Button
              type="button"
              variant="ghost"
              size="sm"
              onClick={() => setShowAll(true)}
              className="w-full"
            >
              Show all timezones
            </Button>
          </div>
        )}

        {/* Full timezone list (search results or all) */}
        {(searchQuery || showAll) && (
          <div className="space-y-2">
            <div className="grid gap-1 max-h-48 overflow-y-auto border rounded-lg p-2">
              {filteredTimezones.length === 0 ? (
                <p className="text-sm text-muted-foreground text-center py-4">
                  No timezones found matching "{searchQuery}"
                </p>
              ) : (
                filteredTimezones.map((tzId) => (
                  <button
                    key={tzId}
                    type="button"
                    onClick={() => handleTimezoneSelect(tzId)}
                    className={cn(
                      'flex items-center justify-between p-2 rounded text-left transition-colors text-sm',
                      'hover:bg-accent',
                      selectedTimezone === tzId
                        ? 'bg-primary/10 text-primary font-medium'
                        : ''
                    )}
                  >
                    <span className="truncate">{formatTimezone(tzId)}</span>
                    {selectedTimezone === tzId && (
                      <Check className="h-4 w-4 flex-shrink-0" />
                    )}
                  </button>
                ))
              )}
            </div>

            {showAll && !searchQuery && (
              <Button
                type="button"
                variant="ghost"
                size="sm"
                onClick={() => setShowAll(false)}
                className="w-full"
              >
                Show common timezones only
              </Button>
            )}
          </div>
        )}
      </div>

      {/* Retry detection button */}
      {!detectedTimezone && !isDetecting && (
        <Button
          type="button"
          variant="outline"
          size="sm"
          onClick={() => retryDetection()}
          className="w-full"
        >
          <RefreshCw className="h-4 w-4 mr-2" />
          Retry auto-detection
        </Button>
      )}
    </div>
  );
}

export default TimezoneStep;
```

---

## Step 6: CompletionStep

Create `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/CompletionStep.tsx`:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/components/onboarding/CompletionStep.tsx

import { useEffect, useState, useCallback } from 'react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  CheckCircle2,
  Wifi,
  Smartphone,
  Clock,
  Ticket,
  Loader2,
  AlertCircle,
  ExternalLink,
  Copy,
  Check,
} from 'lucide-react';

import type { WizardStepProps, OnboardingConfig } from '@/types/onboarding';
import { useCompleteOnboarding } from '@/hooks/useOnboardingApi';
import { cn } from '@/lib/utils';

/**
 * Summary item for displaying configured values.
 */
interface SummaryItemProps {
  icon: React.ReactNode;
  label: string;
  value: string;
  subValue?: string;
}

function SummaryItem({ icon, label, value, subValue }: SummaryItemProps) {
  return (
    <div className="flex items-start gap-3 p-3 bg-muted/30 rounded-lg">
      <div className="flex-shrink-0 text-muted-foreground">{icon}</div>
      <div className="min-w-0 flex-1">
        <p className="text-sm text-muted-foreground">{label}</p>
        <p className="font-medium truncate">{value}</p>
        {subValue && (
          <p className="text-sm text-muted-foreground truncate">{subValue}</p>
        )}
      </div>
    </div>
  );
}

/**
 * CompletionStep - Final step of onboarding wizard.
 *
 * Shows:
 * - Summary of all configured values
 * - Submits configuration to backend
 * - Success message with next steps
 * - Instructions for switching networks
 * - Dashboard link/button
 *
 * Features:
 * - Automatic submission on mount
 * - Loading and error states
 * - Copy new IP address to clipboard
 */
export function CompletionStep({ data, setCanProceed }: WizardStepProps) {
  // -------------------------------------------------------------------------
  // State
  // -------------------------------------------------------------------------

  const [isSubmitted, setIsSubmitted] = useState(false);
  const [dashboardUrl, setDashboardUrl] = useState<string | null>(null);
  const [newIpAddress, setNewIpAddress] = useState<string | null>(null);
  const [copiedIp, setCopiedIp] = useState(false);

  // Mutation for completing onboarding
  const {
    mutate: completeOnboarding,
    isPending: isSubmitting,
    error: submitError,
    reset: resetSubmit,
  } = useCompleteOnboarding();

  // -------------------------------------------------------------------------
  // Build config from wizard data
  // -------------------------------------------------------------------------

  const buildConfig = useCallback((): OnboardingConfig | null => {
    const { bluetooth, signalThreshold, passes, wifi, timezone } = data;

    if (!bluetooth.selectedDevice) return null;
    if (!wifi.ssid || !wifi.password) return null;
    if (!timezone.selected) return null;

    return {
      bluetooth: {
        deviceId: bluetooth.selectedDevice.id,
        deviceName: bluetooth.selectedDevice.name,
        signalThreshold: signalThreshold.threshold,
      },
      passes: {
        monthlyCount: passes.monthlyCount,
      },
      wifi: {
        ssid: wifi.ssid.trim(),
        password: wifi.password,
        isPrimary: true,
      },
      timezone: timezone.selected,
    };
  }, [data]);

  // -------------------------------------------------------------------------
  // Effects
  // -------------------------------------------------------------------------

  // Submit configuration automatically on mount
  useEffect(() => {
    if (isSubmitted || isSubmitting) return;

    const config = buildConfig();
    if (!config) {
      console.error('Invalid configuration data');
      return;
    }

    completeOnboarding(config, {
      onSuccess: (result) => {
        setIsSubmitted(true);
        setDashboardUrl(result.dashboardUrl);
        setNewIpAddress(result.newIpAddress);
      },
    });
  }, [buildConfig, completeOnboarding, isSubmitted, isSubmitting]);

  // Allow proceeding (this is the last step, so always true when submitted)
  useEffect(() => {
    setCanProceed(isSubmitted);
  }, [isSubmitted, setCanProceed]);

  // -------------------------------------------------------------------------
  // Handlers
  // -------------------------------------------------------------------------

  const handleRetry = useCallback(() => {
    resetSubmit();
    const config = buildConfig();
    if (config) {
      completeOnboarding(config, {
        onSuccess: (result) => {
          setIsSubmitted(true);
          setDashboardUrl(result.dashboardUrl);
          setNewIpAddress(result.newIpAddress);
        },
      });
    }
  }, [buildConfig, completeOnboarding, resetSubmit]);

  const handleCopyIp = useCallback(async () => {
    if (!newIpAddress) return;

    try {
      await navigator.clipboard.writeText(newIpAddress);
      setCopiedIp(true);
      setTimeout(() => setCopiedIp(false), 2000);
    } catch (err) {
      console.error('Failed to copy IP address:', err);
    }
  }, [newIpAddress]);

  const handleGoToDashboard = useCallback(() => {
    if (dashboardUrl) {
      window.location.href = dashboardUrl;
    }
  }, [dashboardUrl]);

  // -------------------------------------------------------------------------
  // Render: Loading state
  // -------------------------------------------------------------------------

  if (isSubmitting) {
    return (
      <div className="flex flex-col items-center justify-center py-12 text-center">
        <div className="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-6">
          <Loader2 className="h-8 w-8 text-primary animate-spin" />
        </div>
        <h3 className="text-lg font-semibold mb-2">Completing Setup...</h3>
        <p className="text-sm text-muted-foreground max-w-xs">
          Saving your configuration and connecting to your WiFi network. This
          may take a moment.
        </p>
      </div>
    );
  }

  // -------------------------------------------------------------------------
  // Render: Error state
  // -------------------------------------------------------------------------

  if (submitError) {
    return (
      <div className="space-y-6">
        <div className="flex flex-col items-center justify-center py-8 text-center">
          <div className="w-16 h-16 rounded-full bg-destructive/10 flex items-center justify-center mb-6">
            <AlertCircle className="h-8 w-8 text-destructive" />
          </div>
          <h3 className="text-lg font-semibold mb-2">Setup Failed</h3>
          <p className="text-sm text-muted-foreground max-w-xs mb-4">
            {submitError instanceof Error
              ? submitError.message
              : 'Something went wrong while saving your configuration.'}
          </p>
          <Button onClick={handleRetry} variant="outline">
            Try Again
          </Button>
        </div>

        {/* Configuration summary for debugging */}
        <div className="border-t pt-4">
          <p className="text-sm font-medium mb-3">Your configuration:</p>
          <ConfigurationSummary data={data} />
        </div>
      </div>
    );
  }

  // -------------------------------------------------------------------------
  // Render: Success state
  // -------------------------------------------------------------------------

  return (
    <div className="space-y-6">
      {/* Success header */}
      <div className="flex flex-col items-center text-center py-6">
        <div className="w-16 h-16 rounded-full bg-green-500/10 flex items-center justify-center mb-4">
          <CheckCircle2 className="h-8 w-8 text-green-600 dark:text-green-400" />
        </div>
        <h3 className="text-xl font-semibold mb-1">Setup Complete!</h3>
        <p className="text-muted-foreground">
          tether is now configured and ready to use.
        </p>
      </div>

      {/* Configuration summary */}
      <ConfigurationSummary data={data} />

      {/* Next steps */}
      <div className="bg-amber-500/10 border border-amber-500/20 rounded-lg p-4 space-y-3">
        <div className="flex items-start gap-3">
          <Wifi className="h-5 w-5 text-amber-600 dark:text-amber-400 flex-shrink-0 mt-0.5" />
          <div className="space-y-2">
            <p className="font-medium text-amber-900 dark:text-amber-200">
              Important: Switch Networks
            </p>
            <ol className="text-sm text-amber-800 dark:text-amber-300 space-y-1 list-decimal list-inside">
              <li>
                Disconnect from the temporary "tether-setup" network
              </li>
              <li>
                Connect to your home WiFi ({data.wifi.ssid})
              </li>
              <li>
                Access the dashboard at the new address below
              </li>
            </ol>
          </div>
        </div>
      </div>

      {/* New IP address */}
      {newIpAddress && (
        <div className="flex items-center gap-2 p-3 bg-muted rounded-lg">
          <span className="text-sm text-muted-foreground">New address:</span>
          <code className="flex-1 font-mono text-sm bg-background px-2 py-1 rounded">
            http://{newIpAddress}
          </code>
          <Button
            type="button"
            variant="ghost"
            size="icon"
            onClick={handleCopyIp}
            className="h-8 w-8"
            aria-label="Copy IP address"
          >
            {copiedIp ? (
              <Check className="h-4 w-4 text-green-600" />
            ) : (
              <Copy className="h-4 w-4" />
            )}
          </Button>
        </div>
      )}

      {/* Dashboard button */}
      <Button
        onClick={handleGoToDashboard}
        className="w-full"
        size="lg"
        disabled={!dashboardUrl}
      >
        Go to Dashboard
        <ExternalLink className="h-4 w-4 ml-2" />
      </Button>

      {/* Additional info */}
      <p className="text-xs text-center text-muted-foreground">
        You can also access the dashboard later by visiting the device's IP
        address on your home network.
      </p>
    </div>
  );
}

/**
 * Configuration summary sub-component.
 */
function ConfigurationSummary({ data }: { data: WizardStepProps['data'] }) {
  const { bluetooth, signalThreshold, passes, wifi, timezone } = data;

  return (
    <div className="grid gap-2">
      <SummaryItem
        icon={<Smartphone className="h-4 w-4" />}
        label="Bluetooth Device"
        value={bluetooth.selectedDevice?.name || 'Unknown Device'}
        subValue={`Threshold: ${signalThreshold.threshold} dBm`}
      />
      <SummaryItem
        icon={<Ticket className="h-4 w-4" />}
        label="Monthly Passes"
        value={`${passes.monthlyCount} ${passes.monthlyCount === 1 ? 'pass' : 'passes'}`}
      />
      <SummaryItem
        icon={<Wifi className="h-4 w-4" />}
        label="WiFi Network"
        value={wifi.ssid}
      />
      <SummaryItem
        icon={<Clock className="h-4 w-4" />}
        label="Timezone"
        value={timezone.selected.split('/').pop()?.replace(/_/g, ' ') || timezone.selected}
        subValue={timezone.selected}
      />
    </div>
  );
}

export default CompletionStep;
```

---

## Utility Function: cn()

Ensure `/Users/jeffrey/code/tether/web-ui/src/lib/utils.ts` exists with:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/lib/utils.ts

import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

/**
 * Utility for merging Tailwind CSS classes with proper precedence.
 * Combines clsx for conditional classes with tailwind-merge for deduplication.
 */
export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```

---

## React Query Provider Setup

Ensure the app has React Query configured in `/Users/jeffrey/code/tether/web-ui/src/main.tsx` or equivalent:

```typescript
// /Users/jeffrey/code/tether/web-ui/src/main.tsx

import React from 'react';
import ReactDOM from 'react-dom/client';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import App from './App';
import './index.css';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // Retry failed queries once before showing error
      retry: 1,
      // Consider data stale after 30 seconds
      staleTime: 30 * 1000,
      // Keep unused data in cache for 5 minutes
      gcTime: 5 * 60 * 1000,
    },
    mutations: {
      // Retry failed mutations once
      retry: 1,
    },
  },
});

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <QueryClientProvider client={queryClient}>
      <App />
    </QueryClientProvider>
  </React.StrictMode>
);
```

---

## Usage Example

```typescript
// /Users/jeffrey/code/tether/web-ui/src/App.tsx

import { OnboardingWizard } from './components/onboarding/OnboardingWizard';
import { useOnboardingStatus } from './hooks/useOnboardingApi';

function App() {
  const { data: status, isLoading } = useOnboardingStatus();

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full" />
      </div>
    );
  }

  // Show onboarding if not completed
  if (!status?.completed) {
    return (
      <OnboardingWizard
        onComplete={() => {
          // Redirect to dashboard after successful onboarding
          window.location.href = '/dashboard';
        }}
      />
    );
  }

  // Otherwise show dashboard
  return <Dashboard />;
}

export default App;
```

---

## File Structure Summary

```
web-ui/
  src/
    components/
      onboarding/
        OnboardingWizard.tsx        # Main wizard orchestrator
        BluetoothScanStep.tsx       # Step 1: Device selection
        SignalThresholdStep.tsx     # Step 2: RSSI threshold
        PassesConfigStep.tsx        # Step 3: Monthly passes
        WifiConfigStep.tsx          # Step 4: WiFi configuration
        TimezoneStep.tsx            # Step 5: Timezone selection
        CompletionStep.tsx          # Step 6: Success & instructions
      ui/
        button.tsx                  # shadcn/ui component
        card.tsx                    # shadcn/ui component
        input.tsx                   # shadcn/ui component
        label.tsx                   # shadcn/ui component
        progress.tsx                # shadcn/ui component
        slider.tsx                  # shadcn/ui component
        select.tsx                  # shadcn/ui component
        badge.tsx                   # shadcn/ui component
    hooks/
      useOnboardingApi.ts           # React Query hooks for API
    types/
      onboarding.ts                 # TypeScript types
    lib/
      utils.ts                      # Utility functions (cn)
    main.tsx                        # App entry with QueryProvider
    App.tsx                         # Root component
```

---

## Backend API Endpoints Required

The frontend expects these endpoints from the Rust axum server:

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/bluetooth/scan` | Trigger Bluetooth scan |
| GET | `/api/bluetooth/devices` | Get discovered devices |
| GET | `/api/bluetooth/devices/:id/rssi` | Poll RSSI for specific device |
| POST | `/api/wifi/configure` | Configure WiFi network |
| POST | `/api/wifi/test` | Test WiFi credentials |
| GET | `/api/timezone/detect` | Auto-detect timezone |
| POST | `/api/timezone/configure` | Set timezone |
| GET | `/api/onboarding/status` | Check if onboarding complete |
| POST | `/api/onboarding/complete` | Submit final configuration |

---

### Critical Files for Implementation

- `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/OnboardingWizard.tsx` - Core wizard orchestrator with step state management, progress tracking, and navigation
- `/Users/jeffrey/code/tether/web-ui/src/types/onboarding.ts` - All TypeScript interfaces and type definitions shared across components
- `/Users/jeffrey/code/tether/web-ui/src/hooks/useOnboardingApi.ts` - React Query hooks for all API interactions
- `/Users/jeffrey/code/tether/web-ui/src/components/onboarding/SignalThresholdStep.tsx` - Most complex step with real-time RSSI polling and visual feedback
- `/Users/jeffrey/code/tether/claude-spec.md` - Project specification defining API contract and requirements
