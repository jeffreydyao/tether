Now I have all the information needed. Let me compile the comprehensive implementation details:

---

# Raspberry Pi Image Build with sdm - Complete Implementation Details

## Table of Contents
1. [Prerequisites](#1-prerequisites)
2. [Directory Structure](#2-directory-structure)
3. [build-image.sh Script](#3-build-imagesh-script)
4. [Custom tether Plugin](#4-custom-tether-plugin)
5. [Plugin Configurations](#5-plugin-configurations)
6. [Assets Directory](#6-assets-directory)
7. [Systemd Service Files](#7-systemd-service-files)
8. [Testing the Image](#8-testing-the-image)

---

## 1. Prerequisites

### 1.1 Build Machine Requirements

The build machine MUST be a Linux system (Raspberry Pi OS, Ubuntu, Debian). macOS and Windows are NOT supported for sdm.

**Required packages (auto-installed by sdm installer):**
- binfmt-support
- coreutils
- gdisk
- keyboard-configuration
- parted
- qemu-user-static
- rsync
- systemd-container
- uuid

**Additional required packages:**
```bash
sudo apt-get install -y xz-utils curl wget
```

**Disk space requirements:**
- Base image: ~500MB compressed, ~2.5GB uncompressed
- Working space for customization: ~4GB minimum
- Final image: ~2-4GB depending on customization
- **Total recommended free space: 10GB minimum**

### 1.2 Install sdm

```bash
# Install sdm (requires sudo)
curl -L https://raw.githubusercontent.com/gitbls/sdm/master/install-sdm | sudo bash

# Verify installation
ls -la /usr/local/sdm/sdm
```

sdm is installed to `/usr/local/sdm/`. The main executable is `/usr/local/sdm/sdm`.

### 1.3 Cross-Compiled Binaries Requirement

Before running the build script, ensure the following are built:
- `tether-server` binary (armv7/armhf for Pi Zero 2 W)
- `dumbpipe` binary (armv7/armhf)
- Web UI production build (in `web-ui/dist/`)

The build script expects these at:
- `target/armv7-unknown-linux-gnueabihf/release/tether-server`
- `target/armv7-unknown-linux-gnueabihf/release/dumbpipe` (or downloaded separately)
- `web-ui/dist/` (Vite production build output)

---

## 2. Directory Structure

```
deploy/
  pi/
    sdm/
      build-image.sh              # Main build script
      plugins/
        tether                    # Custom sdm plugin for tether
      configs/
        apps.txt                  # Package list for apps plugin
        hotspot.conf              # Hotspot plugin configuration (optional)
      assets/
        tether-server             # Copied from cross-compile output
        dumbpipe                  # Copied from cross-compile output  
        web-ui/                   # Copied from web-ui/dist/
        tether.service            # Systemd service for tether-server
        tether-dumbpipe.service   # Systemd service for dumbpipe tunnel
        tether-hotspot.service    # Systemd service for hotspot management
        tether-network-monitor.service  # Network watchdog service
        tether-network-monitor.sh # Network monitoring script
        tether-hotspot.sh         # Hotspot toggle script
        tether.toml               # Default configuration template
        nginx-tether.conf         # Nginx config for web UI
      output/                     # Output directory for built images
```

---

## 3. build-image.sh Script

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/build-image.sh`**

```bash
#!/bin/bash
#
# Tether - Raspberry Pi OS Image Builder using sdm
# Builds a fully configured image for Pi Zero 2 W
#
# Usage: sudo ./build-image.sh [--skip-download] [--clean]
#
# Prerequisites:
#   - Linux system with sdm installed (/usr/local/sdm/sdm)
#   - Cross-compiled binaries in target/armv7-unknown-linux-gnueabihf/release/
#   - Web UI built in web-ui/dist/
#   - At least 10GB free disk space
#
set -euo pipefail

#=============================================================================
# Configuration
#=============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/../../.." && pwd)"

# Raspberry Pi OS Lite (32-bit armhf) - Required for Pi Zero 2 W
# Using 32-bit because Pi Zero 2 W has only 512MB RAM
IMAGE_URL="https://downloads.raspberrypi.com/raspios_lite_armhf/images/raspios_lite_armhf-2025-12-04/2025-12-04-raspios-trixie-armhf-lite.img.xz"
IMAGE_FILENAME="2025-12-04-raspios-trixie-armhf-lite.img.xz"
IMAGE_UNCOMPRESSED="2025-12-04-raspios-trixie-armhf-lite.img"

# Directories
DOWNLOAD_DIR="${SCRIPT_DIR}/downloads"
OUTPUT_DIR="${SCRIPT_DIR}/output"
ASSETS_DIR="${SCRIPT_DIR}/assets"
CONFIGS_DIR="${SCRIPT_DIR}/configs"
PLUGINS_DIR="${SCRIPT_DIR}/plugins"

# Source binaries (from cross-compilation)
CROSS_TARGET="armv7-unknown-linux-gnueabihf"
BIN_DIR="${PROJECT_ROOT}/target/${CROSS_TARGET}/release"
WEBUI_DIR="${PROJECT_ROOT}/web-ui/dist"

# Output image name
OUTPUT_IMAGE="tether-pi-$(date +%Y%m%d-%H%M%S).img"

# sdm path
SDM="/usr/local/sdm/sdm"

#=============================================================================
# Color Output
#=============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info()  { echo -e "${BLUE}[INFO]${NC} $1"; }
log_ok()    { echo -e "${GREEN}[OK]${NC} $1"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

#=============================================================================
# Preflight Checks
#=============================================================================

preflight_checks() {
    log_info "Running preflight checks..."

    # Must be root
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root (sudo)"
        exit 1
    fi

    # Check sdm is installed
    if [[ ! -x "${SDM}" ]]; then
        log_error "sdm not found at ${SDM}"
        log_error "Install with: curl -L https://raw.githubusercontent.com/gitbls/sdm/master/install-sdm | sudo bash"
        exit 1
    fi
    log_ok "sdm found at ${SDM}"

    # Check cross-compiled binary exists
    if [[ ! -f "${BIN_DIR}/tether-server" ]]; then
        log_error "tether-server binary not found at ${BIN_DIR}/tether-server"
        log_error "Run: cargo build --release --target ${CROSS_TARGET} -p tether-server"
        exit 1
    fi
    log_ok "tether-server binary found"

    # Check web UI build exists
    if [[ ! -d "${WEBUI_DIR}" ]] || [[ ! -f "${WEBUI_DIR}/index.html" ]]; then
        log_error "Web UI build not found at ${WEBUI_DIR}"
        log_error "Run: cd web-ui && bun run build"
        exit 1
    fi
    log_ok "Web UI build found"

    # Check disk space (need at least 8GB free)
    AVAILABLE_KB=$(df "${SCRIPT_DIR}" | awk 'NR==2 {print $4}')
    AVAILABLE_GB=$((AVAILABLE_KB / 1024 / 1024))
    if [[ ${AVAILABLE_GB} -lt 8 ]]; then
        log_error "Insufficient disk space. Need at least 8GB, have ${AVAILABLE_GB}GB"
        exit 1
    fi
    log_ok "Disk space: ${AVAILABLE_GB}GB available"

    # Check plugin exists
    if [[ ! -f "${PLUGINS_DIR}/tether" ]]; then
        log_error "tether plugin not found at ${PLUGINS_DIR}/tether"
        exit 1
    fi
    log_ok "tether plugin found"
}

#=============================================================================
# Download Base Image
#=============================================================================

download_base_image() {
    log_info "Checking base image..."

    mkdir -p "${DOWNLOAD_DIR}"

    if [[ -f "${DOWNLOAD_DIR}/${IMAGE_UNCOMPRESSED}" ]]; then
        log_ok "Base image already exists: ${IMAGE_UNCOMPRESSED}"
        return 0
    fi

    if [[ -f "${DOWNLOAD_DIR}/${IMAGE_FILENAME}" ]]; then
        log_info "Compressed image exists, decompressing..."
    else
        log_info "Downloading Raspberry Pi OS Lite..."
        log_info "URL: ${IMAGE_URL}"
        
        wget --progress=bar:force:noscroll \
            -O "${DOWNLOAD_DIR}/${IMAGE_FILENAME}" \
            "${IMAGE_URL}"
        
        log_ok "Download complete"
    fi

    log_info "Decompressing image (this takes a few minutes)..."
    xz -dk "${DOWNLOAD_DIR}/${IMAGE_FILENAME}"
    log_ok "Decompression complete"
}

#=============================================================================
# Prepare Assets
#=============================================================================

prepare_assets() {
    log_info "Preparing assets for image..."

    # Create assets directory structure
    mkdir -p "${ASSETS_DIR}/bin"
    mkdir -p "${ASSETS_DIR}/web-ui"
    mkdir -p "${ASSETS_DIR}/systemd"
    mkdir -p "${ASSETS_DIR}/config"
    mkdir -p "${ASSETS_DIR}/scripts"
    mkdir -p "${ASSETS_DIR}/nginx"

    # Copy tether-server binary
    log_info "Copying tether-server binary..."
    cp "${BIN_DIR}/tether-server" "${ASSETS_DIR}/bin/"
    chmod 755 "${ASSETS_DIR}/bin/tether-server"

    # Copy dumbpipe binary if it exists in our build, otherwise it will be downloaded
    if [[ -f "${BIN_DIR}/dumbpipe" ]]; then
        log_info "Copying dumbpipe binary..."
        cp "${BIN_DIR}/dumbpipe" "${ASSETS_DIR}/bin/"
        chmod 755 "${ASSETS_DIR}/bin/dumbpipe"
    else
        log_warn "dumbpipe binary not found in build output"
        log_warn "Will need to download or build separately"
    fi

    # Copy web UI
    log_info "Copying web UI..."
    rsync -a --delete "${WEBUI_DIR}/" "${ASSETS_DIR}/web-ui/"

    log_ok "Assets prepared"
}

#=============================================================================
# Create Working Image Copy
#=============================================================================

create_working_copy() {
    log_info "Creating working copy of base image..."

    mkdir -p "${OUTPUT_DIR}"
    
    WORK_IMAGE="${OUTPUT_DIR}/${OUTPUT_IMAGE}"
    
    cp "${DOWNLOAD_DIR}/${IMAGE_UNCOMPRESSED}" "${WORK_IMAGE}"
    
    log_ok "Working image created: ${WORK_IMAGE}"
}

#=============================================================================
# Run sdm Customization
#=============================================================================

run_sdm_customize() {
    log_info "Running sdm customization..."
    log_info "This will take 10-20 minutes depending on network speed..."

    WORK_IMAGE="${OUTPUT_DIR}/${OUTPUT_IMAGE}"

    # Extend image to have room for customization
    # Pi OS Lite is ~2GB, we need ~4GB for all our additions
    log_info "Extending image by 2048MB..."
    ${SDM} --extend --xmb 2048 "${WORK_IMAGE}"

    #=========================================================================
    # CRITICAL: Plugin order matters!
    # 
    # Order explanation:
    # 1. L10n - Must be first to set locale before any package installation
    # 2. user - Create tether user before copying files with ownership
    # 3. apps - Install system packages (nginx, bluez, etc.)
    # 4. raspiconfig - Enable hardware interfaces (bluetooth, etc.)
    # 5. copyfile - Copy all our assets into the image
    # 6. tether (custom) - Configure tether-specific setup
    # 7. system - Enable/disable services (must be after tether creates them)
    # 8. hotspot - Configure NetworkManager hotspot (must be after apps installs NM)
    # 9. network - Configure primary network settings (after hotspot)
    # 10. chrony - Time sync (can be anywhere after apps)
    #=========================================================================

    ${SDM} --customize "${WORK_IMAGE}" \
        \
        --plugin L10n:"keymap=us|locale=en_US.UTF-8|timezone=UTC|wificountry=US" \
        \
        --plugin user:"adduser=tether|password=tether|groups=sudo,bluetooth,netdev,gpio,i2c,spi|homedir=/home/tether" \
        \
        --plugin apps:"apps=@${CONFIGS_DIR}/apps.txt|name=tether-apps" \
        \
        --plugin raspiconfig:"serial=1|i2c=1|spi=1" \
        \
        --plugin copyfile:"filelist=${CONFIGS_DIR}/copyfiles.txt" \
        \
        --plugin "${PLUGINS_DIR}/tether" \
        \
        --plugin system:"service-enable=tether,tether-dumbpipe,tether-hotspot,tether-network-monitor,nginx|service-disable=bluetooth|swap=0" \
        \
        --plugin hotspot:"hsname=TetherSetup|wifissid=TetherSetup|wifipassword=|device=wlan0|type=routed|hsenable=n" \
        \
        --plugin chrony:"nodistsources" \
        \
        --regen-ssh-host-keys \
        --restart

    log_ok "sdm customization complete"
}

#=============================================================================
# Shrink Final Image
#=============================================================================

shrink_image() {
    log_info "Shrinking final image to minimum size..."
    
    WORK_IMAGE="${OUTPUT_DIR}/${OUTPUT_IMAGE}"
    
    ${SDM} --shrink "${WORK_IMAGE}"
    
    # Get final size
    FINAL_SIZE=$(du -h "${WORK_IMAGE}" | cut -f1)
    log_ok "Final image size: ${FINAL_SIZE}"
}

#=============================================================================
# Generate SHA256 Checksum
#=============================================================================

generate_checksum() {
    log_info "Generating SHA256 checksum..."
    
    WORK_IMAGE="${OUTPUT_DIR}/${OUTPUT_IMAGE}"
    
    sha256sum "${WORK_IMAGE}" > "${WORK_IMAGE}.sha256"
    
    log_ok "Checksum saved to ${WORK_IMAGE}.sha256"
}

#=============================================================================
# Main
#=============================================================================

main() {
    echo "=============================================="
    echo "  Tether - Raspberry Pi Image Builder"
    echo "=============================================="
    echo ""

    # Parse arguments
    SKIP_DOWNLOAD=false
    CLEAN=false
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --skip-download)
                SKIP_DOWNLOAD=true
                shift
                ;;
            --clean)
                CLEAN=true
                shift
                ;;
            *)
                log_error "Unknown option: $1"
                exit 1
                ;;
        esac
    done

    # Clean if requested
    if [[ "${CLEAN}" == "true" ]]; then
        log_info "Cleaning output directory..."
        rm -rf "${OUTPUT_DIR}"
        log_ok "Clean complete"
    fi

    # Run build steps
    preflight_checks
    
    if [[ "${SKIP_DOWNLOAD}" != "true" ]]; then
        download_base_image
    fi
    
    prepare_assets
    create_working_copy
    run_sdm_customize
    shrink_image
    generate_checksum

    echo ""
    echo "=============================================="
    log_ok "BUILD COMPLETE"
    echo "=============================================="
    echo ""
    echo "Output image: ${OUTPUT_DIR}/${OUTPUT_IMAGE}"
    echo "Checksum:     ${OUTPUT_DIR}/${OUTPUT_IMAGE}.sha256"
    echo ""
    echo "To flash to SD card:"
    echo "  sudo dd if=${OUTPUT_DIR}/${OUTPUT_IMAGE} of=/dev/sdX bs=4M status=progress conv=fsync"
    echo ""
    echo "Or use Raspberry Pi Imager."
    echo ""
}

main "$@"
```

---

## 4. Custom tether Plugin

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/plugins/tether`**

```bash
#!/bin/bash
#
# sdm plugin: tether
#
# This plugin configures the tether service for Raspberry Pi
# It handles:
#   - Phase 0: Copy binaries and assets to correct locations
#   - Phase 1: Set permissions, create directories
#   - Post-install: Configure systemd services, create first-boot scripts
#

function loadparams() {
    source $SDMPT/etc/sdm/sdm-readparams
}

# $1 is the phase: "0", "1", or "post-install"
# $2 is the argument list: arg1=val1|arg2=val2|...

phase=$1
pfx="$(basename $0)"     # Plugin name for logging
args="$2"

# Define valid and required arguments
vldargs="|assetdir|"     # Valid arguments (pipe-delimited)
rqdargs=""               # Required arguments (none for this plugin)

# Asset directory - where our files are staged during build
# This is set by the build script
assetdir=""

if [[ "$phase" == "0" ]]; then
    #=========================================================================
    # Phase 0: Mounted Disk Environment
    # The image is mounted at $SDMPT. All file operations must use $SDMPT prefix.
    # Network and host system resources are available.
    #=========================================================================
    
    loadparams
    
    # Parse plugin arguments
    plugin_getargs $pfx "$args" "$vldargs" "$rqdargs" || exit
    plugin_printkeys
    
    logtoboth "* Plugin $pfx: Phase 0 - Copying tether files to image"
    
    # Determine asset directory - check common locations
    if [[ -z "$assetdir" ]]; then
        # Look for assets in the directory containing this plugin
        PLUGIN_DIR="$(dirname "$(realpath "$0")")"
        assetdir="${PLUGIN_DIR}/../assets"
    fi
    
    if [[ ! -d "$assetdir" ]]; then
        logtoboth "? Plugin $pfx: Asset directory not found: $assetdir"
        exit 1
    fi
    
    logtoboth "> Plugin $pfx: Using asset directory: $assetdir"
    
    #-------------------------------------------------------------------------
    # Create directory structure in the image
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Creating directory structure"
    
    mkdir -p $SDMPT/opt/tether/bin
    mkdir -p $SDMPT/opt/tether/web-ui
    mkdir -p $SDMPT/opt/tether/config
    mkdir -p $SDMPT/opt/tether/data
    mkdir -p $SDMPT/opt/tether/logs
    mkdir -p $SDMPT/opt/tether/scripts
    mkdir -p $SDMPT/etc/nginx/sites-available
    mkdir -p $SDMPT/etc/nginx/sites-enabled
    
    #-------------------------------------------------------------------------
    # Copy binaries
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Copying tether-server binary"
    cp "$assetdir/bin/tether-server" $SDMPT/opt/tether/bin/
    chmod 755 $SDMPT/opt/tether/bin/tether-server
    
    if [[ -f "$assetdir/bin/dumbpipe" ]]; then
        logtoboth "> Plugin $pfx: Copying dumbpipe binary"
        cp "$assetdir/bin/dumbpipe" $SDMPT/opt/tether/bin/
        chmod 755 $SDMPT/opt/tether/bin/dumbpipe
    fi
    
    #-------------------------------------------------------------------------
    # Copy web UI
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Copying web UI"
    cp -r "$assetdir/web-ui/"* $SDMPT/opt/tether/web-ui/
    
    #-------------------------------------------------------------------------
    # Copy systemd service files
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Copying systemd service files"
    
    cp "$assetdir/systemd/tether.service" $SDMPT/etc/systemd/system/
    cp "$assetdir/systemd/tether-dumbpipe.service" $SDMPT/etc/systemd/system/
    cp "$assetdir/systemd/tether-hotspot.service" $SDMPT/etc/systemd/system/
    cp "$assetdir/systemd/tether-network-monitor.service" $SDMPT/etc/systemd/system/
    
    chmod 644 $SDMPT/etc/systemd/system/tether*.service
    
    #-------------------------------------------------------------------------
    # Copy scripts
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Copying management scripts"
    
    cp "$assetdir/scripts/tether-hotspot.sh" $SDMPT/opt/tether/scripts/
    cp "$assetdir/scripts/tether-network-monitor.sh" $SDMPT/opt/tether/scripts/
    
    chmod 755 $SDMPT/opt/tether/scripts/*.sh
    
    #-------------------------------------------------------------------------
    # Copy nginx configuration
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Copying nginx configuration"
    
    cp "$assetdir/nginx/tether.conf" $SDMPT/etc/nginx/sites-available/
    
    # Remove default site, link tether site
    rm -f $SDMPT/etc/nginx/sites-enabled/default
    ln -sf /etc/nginx/sites-available/tether.conf $SDMPT/etc/nginx/sites-enabled/tether.conf
    
    #-------------------------------------------------------------------------
    # Copy default configuration
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Copying default configuration"
    
    cp "$assetdir/config/tether.toml" $SDMPT/opt/tether/config/
    
    logtoboth "* Plugin $pfx: Phase 0 complete"

elif [[ "$phase" == "1" ]]; then
    #=========================================================================
    # Phase 1: nspawn Container Environment
    # Running inside the image via systemd-nspawn.
    # $SDMPT is empty - use paths directly (e.g., /opt/tether, not $SDMPT/opt/tether)
    # apt and systemctl commands work here.
    #=========================================================================
    
    loadparams
    
    logtoboth "* Plugin $pfx: Phase 1 - Configuring tether inside container"
    
    #-------------------------------------------------------------------------
    # Set ownership of tether directories
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Setting file ownership"
    
    # The 'tether' user is created by the user plugin before this runs
    chown -R tether:tether /opt/tether
    
    # Config and data need to be writable by the service
    chmod 755 /opt/tether
    chmod 755 /opt/tether/bin
    chmod 755 /opt/tether/web-ui
    chmod 700 /opt/tether/config
    chmod 700 /opt/tether/data
    chmod 755 /opt/tether/logs
    chmod 755 /opt/tether/scripts
    
    #-------------------------------------------------------------------------
    # Configure NetworkManager to allow hotspot management
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Configuring NetworkManager permissions"
    
    # Create polkit rule to allow tether user to manage NetworkManager
    mkdir -p /etc/polkit-1/rules.d
    
    cat > /etc/polkit-1/rules.d/50-tether-network.rules << 'POLKIT_EOF'
// Allow tether user to manage NetworkManager connections
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("org.freedesktop.NetworkManager.") == 0 &&
        subject.user == "tether") {
        return polkit.Result.YES;
    }
});
POLKIT_EOF
    
    chmod 644 /etc/polkit-1/rules.d/50-tether-network.rules
    
    #-------------------------------------------------------------------------
    # Configure Bluetooth permissions
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Configuring Bluetooth permissions"
    
    # tether user is already in bluetooth group (added by user plugin)
    # Just need to ensure bluetooth service allows our user
    
    # Create D-Bus policy for bluetooth access
    cat > /etc/dbus-1/system.d/tether-bluetooth.conf << 'DBUS_EOF'
<!DOCTYPE busconfig PUBLIC
 "-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
<busconfig>
    <policy user="tether">
        <allow own="org.bluez"/>
        <allow send_destination="org.bluez"/>
        <allow send_interface="org.bluez.GattCharacteristic1"/>
        <allow send_interface="org.bluez.GattDescriptor1"/>
        <allow send_interface="org.freedesktop.DBus.ObjectManager"/>
        <allow send_interface="org.freedesktop.DBus.Properties"/>
    </policy>
</busconfig>
DBUS_EOF
    
    chmod 644 /etc/dbus-1/system.d/tether-bluetooth.conf
    
    logtoboth "* Plugin $pfx: Phase 1 complete"

elif [[ "$phase" == "post-install" ]]; then
    #=========================================================================
    # Post-install Phase: After all packages are installed
    # Still in nspawn container. Final configuration goes here.
    #=========================================================================
    
    loadparams
    
    logtoboth "* Plugin $pfx: Post-install - Final configuration"
    
    #-------------------------------------------------------------------------
    # Create first-boot script for initial setup
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Creating first-boot initialization script"
    
    mkdir -p /etc/sdm/0piboot
    
    # This script runs on first boot to initialize tether
    cat > /etc/sdm/0piboot/099-tether-firstboot.sh << 'FIRSTBOOT_EOF'
#!/bin/bash
#
# Tether first-boot initialization
# This runs once on the very first boot of the Pi
#

LOGFILE="/opt/tether/logs/firstboot.log"
exec > >(tee -a "$LOGFILE") 2>&1

echo "=========================================="
echo "Tether First Boot Initialization"
echo "Date: $(date)"
echo "=========================================="

# Wait for system to fully initialize
sleep 5

#-----------------------------------------------------------------------------
# Check if this is truly first boot (no config file modified)
#-----------------------------------------------------------------------------

CONFIG_FILE="/opt/tether/config/tether.toml"
DATA_DIR="/opt/tether/data"

if [[ -f "$DATA_DIR/.initialized" ]]; then
    echo "System already initialized, skipping first-boot setup"
    exit 0
fi

echo "Starting first-boot initialization..."

#-----------------------------------------------------------------------------
# Initialize data directory
#-----------------------------------------------------------------------------

echo "Initializing data directory..."
mkdir -p "$DATA_DIR"
touch "$DATA_DIR/.initialized"
chown -R tether:tether "$DATA_DIR"

#-----------------------------------------------------------------------------
# Generate unique device identifier
#-----------------------------------------------------------------------------

echo "Generating device identifier..."
DEVICE_ID=$(cat /proc/cpuinfo | grep Serial | cut -d ' ' -f 2 | tail -c 9)
echo "Device ID: $DEVICE_ID"

# Update config with device ID if template placeholder exists
if grep -q "{{DEVICE_ID}}" "$CONFIG_FILE" 2>/dev/null; then
    sed -i "s/{{DEVICE_ID}}/$DEVICE_ID/g" "$CONFIG_FILE"
fi

#-----------------------------------------------------------------------------
# Start hotspot for initial configuration
#-----------------------------------------------------------------------------

echo "Starting configuration hotspot..."

# The hotspot is managed by tether-hotspot.service
# It checks if the device is configured and starts hotspot if not
systemctl start tether-hotspot.service

#-----------------------------------------------------------------------------
# Ensure services are running
#-----------------------------------------------------------------------------

echo "Starting tether services..."

systemctl daemon-reload
systemctl enable tether.service
systemctl enable tether-dumbpipe.service
systemctl enable tether-hotspot.service
systemctl enable tether-network-monitor.service
systemctl start tether.service

echo "=========================================="
echo "First-boot initialization complete"
echo "=========================================="

FIRSTBOOT_EOF

    chmod 755 /etc/sdm/0piboot/099-tether-firstboot.sh
    
    #-------------------------------------------------------------------------
    # Create systemd override for NetworkManager to wait for it
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Creating service dependencies"
    
    mkdir -p /etc/systemd/system/tether.service.d
    
    cat > /etc/systemd/system/tether.service.d/override.conf << 'OVERRIDE_EOF'
[Unit]
After=network-online.target NetworkManager.service bluetooth.service
Wants=network-online.target
OVERRIDE_EOF
    
    chmod 644 /etc/systemd/system/tether.service.d/override.conf
    
    #-------------------------------------------------------------------------
    # Configure log rotation
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Configuring log rotation"
    
    cat > /etc/logrotate.d/tether << 'LOGROTATE_EOF'
/opt/tether/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 tether tether
}
LOGROTATE_EOF
    
    chmod 644 /etc/logrotate.d/tether
    
    #-------------------------------------------------------------------------
    # Add helpful message to motd
    #-------------------------------------------------------------------------
    
    logtoboth "> Plugin $pfx: Updating message of the day"
    
    cat >> /etc/motd << 'MOTD_EOF'

========================================
  TETHER - Phone Accountability Device
========================================
Web UI:    http://tether.local or http://$(hostname -I | awk '{print $1}')
Logs:      /opt/tether/logs/
Config:    /opt/tether/config/tether.toml
Status:    systemctl status tether
========================================

MOTD_EOF
    
    logtoboth "* Plugin $pfx: Post-install complete"
    
    plugin_addnote ""
    plugin_addnote "===== Tether Configuration ====="
    plugin_addnote "On first boot, connect to WiFi network: TetherSetup"
    plugin_addnote "Then visit http://192.168.4.1 to configure"
    plugin_addnote "================================"
    plugin_addnote ""

fi
```

---

## 5. Plugin Configurations

### 5.1 Apps List

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/configs/apps.txt`**

```
# Tether - Required Packages
# One package per line, comments start with #

# Web server for UI
nginx

# Bluetooth stack
bluez
bluetooth
pi-bluetooth

# Network management (already included in Bookworm but ensure it's there)
network-manager

# Useful utilities
curl
wget
jq

# mDNS for tether.local hostname
avahi-daemon

# Time synchronization (chrony plugin handles this, but ensure base)
chrony

# SSL certificates for potential HTTPS
ca-certificates

# System utilities
htop
vim-tiny

# For network diagnostics
iproute2
iputils-ping
dnsutils
```

### 5.2 Copyfiles List

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/configs/copyfiles.txt`**

This file tells the copyfile plugin what to copy. Format: `from=<source>|to=<dest>|chmod=<mode>|chown=<owner>|mkdirif=yes`

```
# Copyfiles configuration for tether
# Format: from=source|to=destination|chmod=mode|chown=owner:group|mkdirif=yes

# Note: The tether plugin handles most file copying internally
# This file is for any additional system-wide configurations

# Hostname configuration
# from=/path/to/hostname|to=/etc|chmod=644|chown=root:root|

# The tether plugin copies:
# - /opt/tether/bin/tether-server
# - /opt/tether/bin/dumbpipe  
# - /opt/tether/web-ui/*
# - /opt/tether/config/tether.toml
# - /opt/tether/scripts/*
# - /etc/systemd/system/tether*.service
# - /etc/nginx/sites-available/tether.conf
```

### 5.3 Plugin Argument Reference

Here are the exact plugin invocations used in `build-image.sh`:

```bash
# L10n Plugin - Localization settings
--plugin L10n:"keymap=us|locale=en_US.UTF-8|timezone=UTC|wificountry=US"

# User Plugin - Create tether user
--plugin user:"adduser=tether|password=tether|groups=sudo,bluetooth,netdev,gpio,i2c,spi|homedir=/home/tether"

# Apps Plugin - Install packages from file
--plugin apps:"apps=@${CONFIGS_DIR}/apps.txt|name=tether-apps"

# Raspiconfig Plugin - Enable hardware interfaces
--plugin raspiconfig:"serial=1|i2c=1|spi=1"

# Copyfile Plugin - Copy additional files
--plugin copyfile:"filelist=${CONFIGS_DIR}/copyfiles.txt"

# Custom Tether Plugin - Our custom configuration
--plugin "${PLUGINS_DIR}/tether"

# System Plugin - Service management
--plugin system:"service-enable=tether,tether-dumbpipe,tether-hotspot,tether-network-monitor,nginx|service-disable=bluetooth|swap=0"

# Hotspot Plugin - Configure AP mode capability
--plugin hotspot:"hsname=TetherSetup|wifissid=TetherSetup|wifipassword=|device=wlan0|type=routed|hsenable=n"

# Chrony Plugin - Time synchronization
--plugin chrony:"nodistsources"
```

**Critical Notes on Plugin Arguments:**

1. **Pipe delimiter (`|`)**: Arguments within a plugin are separated by `|`
2. **Colon after plugin name**: The plugin name is followed by `:` then quotes containing arguments
3. **File references with `@`**: Use `@/path/to/file` to reference file contents (apps plugin)
4. **Plugin path**: Custom plugins must use full path: `--plugin /path/to/plugin`
5. **No spaces around `=`**: Arguments are `key=value` not `key = value`

---

## 6. Assets Directory

### 6.1 Complete File List

```
deploy/pi/sdm/assets/
  bin/
    tether-server           # Cross-compiled armv7 binary (from build)
    dumbpipe                # Cross-compiled armv7 binary (from build or download)
  
  web-ui/                   # Contents of web-ui/dist/ after bun run build
    index.html
    assets/
      index-[hash].js
      index-[hash].css
    favicon.ico
    ... (all other built files)
  
  systemd/
    tether.service
    tether-dumbpipe.service
    tether-hotspot.service
    tether-network-monitor.service
  
  scripts/
    tether-hotspot.sh
    tether-network-monitor.sh
  
  config/
    tether.toml
  
  nginx/
    tether.conf
```

### 6.2 Destination Paths in Image

| Source (assets/) | Destination in Image | Permissions | Owner |
|------------------|---------------------|-------------|-------|
| `bin/tether-server` | `/opt/tether/bin/tether-server` | 755 | tether:tether |
| `bin/dumbpipe` | `/opt/tether/bin/dumbpipe` | 755 | tether:tether |
| `web-ui/*` | `/opt/tether/web-ui/` | 755 (dirs), 644 (files) | tether:tether |
| `systemd/*.service` | `/etc/systemd/system/` | 644 | root:root |
| `scripts/*.sh` | `/opt/tether/scripts/` | 755 | tether:tether |
| `config/tether.toml` | `/opt/tether/config/tether.toml` | 600 | tether:tether |
| `nginx/tether.conf` | `/etc/nginx/sites-available/tether.conf` | 644 | root:root |

---

## 7. Systemd Service Files

### 7.1 tether.service

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/systemd/tether.service`**

```ini
[Unit]
Description=Tether Phone Accountability Service
Documentation=https://github.com/yourrepo/tether
After=network-online.target NetworkManager.service bluetooth.service
Wants=network-online.target
Requires=bluetooth.service

[Service]
Type=simple
User=tether
Group=tether
WorkingDirectory=/opt/tether
Environment=RUST_LOG=info
Environment=TETHER_CONFIG=/opt/tether/config/tether.toml
Environment=TETHER_DATA_DIR=/opt/tether/data
ExecStart=/opt/tether/bin/tether-server
Restart=always
RestartSec=5
StandardOutput=append:/opt/tether/logs/tether.log
StandardError=append:/opt/tether/logs/tether.log

# Security hardening
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/tether/data /opt/tether/logs /opt/tether/config
PrivateTmp=true

# Capabilities needed for Bluetooth
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_RAW

[Install]
WantedBy=multi-user.target
```

### 7.2 tether-dumbpipe.service

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/systemd/tether-dumbpipe.service`**

```ini
[Unit]
Description=Tether Dumbpipe Tunnel (iroh P2P)
Documentation=https://github.com/n0-computer/dumbpipe
After=network-online.target tether.service
Wants=network-online.target
BindsTo=tether.service

[Service]
Type=simple
User=tether
Group=tether
WorkingDirectory=/opt/tether
# Listen on localhost:3000 (where tether-server runs) and expose via iroh
ExecStart=/opt/tether/bin/dumbpipe listen --accept localhost:3000
Restart=always
RestartSec=10
StandardOutput=append:/opt/tether/logs/dumbpipe.log
StandardError=append:/opt/tether/logs/dumbpipe.log

# Store the ticket in a known location for the web UI to read
ExecStartPost=/bin/bash -c 'sleep 5 && /opt/tether/bin/dumbpipe listen --accept localhost:3000 --print-ticket > /opt/tether/data/dumbpipe-ticket.txt 2>/dev/null || true'

# Security hardening
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/tether/data /opt/tether/logs
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

### 7.3 tether-hotspot.service

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/systemd/tether-hotspot.service`**

```ini
[Unit]
Description=Tether Hotspot Manager
Documentation=https://github.com/yourrepo/tether
After=NetworkManager.service
Requires=NetworkManager.service

[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/opt/tether/scripts/tether-hotspot.sh start
ExecStop=/opt/tether/scripts/tether-hotspot.sh stop
StandardOutput=append:/opt/tether/logs/hotspot.log
StandardError=append:/opt/tether/logs/hotspot.log

[Install]
WantedBy=multi-user.target
```

### 7.4 tether-network-monitor.service

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/systemd/tether-network-monitor.service`**

```ini
[Unit]
Description=Tether Network Connectivity Monitor
Documentation=https://github.com/yourrepo/tether
After=NetworkManager.service tether.service
Wants=NetworkManager.service

[Service]
Type=simple
ExecStart=/opt/tether/scripts/tether-network-monitor.sh
Restart=always
RestartSec=30
StandardOutput=append:/opt/tether/logs/network-monitor.log
StandardError=append:/opt/tether/logs/network-monitor.log

[Install]
WantedBy=multi-user.target
```

---

## 8. Supporting Scripts

### 8.1 tether-hotspot.sh

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/scripts/tether-hotspot.sh`**

```bash
#!/bin/bash
#
# Tether Hotspot Management Script
# Controls the WiFi hotspot for initial configuration and fallback
#

set -euo pipefail

HOTSPOT_SSID="TetherSetup"
HOTSPOT_INTERFACE="wlan0"
HOTSPOT_IP="192.168.4.1"
HOTSPOT_CONNECTION="tether-hotspot"
CONFIG_FILE="/opt/tether/config/tether.toml"
INITIALIZED_FLAG="/opt/tether/data/.configured"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

is_configured() {
    [[ -f "$INITIALIZED_FLAG" ]]
}

hotspot_exists() {
    nmcli -t connection show "$HOTSPOT_CONNECTION" &>/dev/null
}

hotspot_active() {
    nmcli -t connection show --active | grep -q "$HOTSPOT_CONNECTION"
}

create_hotspot() {
    log "Creating hotspot connection: $HOTSPOT_CONNECTION"
    
    # Delete existing if present
    nmcli connection delete "$HOTSPOT_CONNECTION" 2>/dev/null || true
    
    # Create new hotspot
    nmcli connection add \
        type wifi \
        con-name "$HOTSPOT_CONNECTION" \
        ifname "$HOTSPOT_INTERFACE" \
        ssid "$HOTSPOT_SSID" \
        autoconnect no \
        wifi.mode ap \
        wifi.band bg \
        ipv4.method shared \
        ipv4.addresses "${HOTSPOT_IP}/24"
    
    # No password for initial setup (open network)
    nmcli connection modify "$HOTSPOT_CONNECTION" wifi-sec.key-mgmt none
    
    log "Hotspot connection created"
}

start_hotspot() {
    log "Starting hotspot..."
    
    if ! hotspot_exists; then
        create_hotspot
    fi
    
    if hotspot_active; then
        log "Hotspot already active"
        return 0
    fi
    
    # Disconnect from any existing WiFi
    nmcli device disconnect "$HOTSPOT_INTERFACE" 2>/dev/null || true
    sleep 2
    
    # Activate hotspot
    nmcli connection up "$HOTSPOT_CONNECTION"
    
    log "Hotspot started on $HOTSPOT_SSID ($HOTSPOT_IP)"
}

stop_hotspot() {
    log "Stopping hotspot..."
    
    if hotspot_active; then
        nmcli connection down "$HOTSPOT_CONNECTION"
        log "Hotspot stopped"
    else
        log "Hotspot not active"
    fi
}

case "${1:-}" in
    start)
        # On first boot or when no network is configured, start hotspot
        if ! is_configured; then
            log "Device not configured, starting hotspot for setup"
            start_hotspot
        else
            log "Device already configured, not starting hotspot automatically"
        fi
        ;;
    stop)
        stop_hotspot
        ;;
    enable)
        # Force enable hotspot (called when network fails)
        start_hotspot
        ;;
    disable)
        # Force disable hotspot (called after successful network connection)
        stop_hotspot
        ;;
    status)
        if hotspot_active; then
            echo "Hotspot is active"
            exit 0
        else
            echo "Hotspot is inactive"
            exit 1
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|enable|disable|status}"
        exit 1
        ;;
esac
```

### 8.2 tether-network-monitor.sh

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/scripts/tether-network-monitor.sh`**

```bash
#!/bin/bash
#
# Tether Network Connectivity Monitor
# Monitors network connectivity and enables hotspot when no network is available
#

set -euo pipefail

CHECK_INTERVAL=60          # Check every 60 seconds
FAIL_THRESHOLD=3           # Number of consecutive failures before enabling hotspot
PING_TARGETS=("8.8.8.8" "1.1.1.1" "208.67.222.222")
HOTSPOT_SCRIPT="/opt/tether/scripts/tether-hotspot.sh"
CONFIGURED_FLAG="/opt/tether/data/.configured"

fail_count=0
hotspot_mode=false

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

check_internet() {
    for target in "${PING_TARGETS[@]}"; do
        if ping -c 1 -W 5 "$target" &>/dev/null; then
            return 0
        fi
    done
    return 1
}

is_configured() {
    [[ -f "$CONFIGURED_FLAG" ]]
}

enable_hotspot() {
    if [[ "$hotspot_mode" == "false" ]]; then
        log "Enabling hotspot due to network failure"
        "$HOTSPOT_SCRIPT" enable
        hotspot_mode=true
    fi
}

disable_hotspot() {
    if [[ "$hotspot_mode" == "true" ]]; then
        log "Disabling hotspot, network restored"
        "$HOTSPOT_SCRIPT" disable
        hotspot_mode=false
    fi
}

main() {
    log "Starting network monitor"
    
    # If not configured, don't interfere with hotspot service
    if ! is_configured; then
        log "Device not configured, letting hotspot service handle things"
        # Keep running but don't do anything
        while true; do
            sleep "$CHECK_INTERVAL"
            if is_configured; then
                log "Device now configured, starting monitoring"
                break
            fi
        done
    fi
    
    while true; do
        if check_internet; then
            log "Network OK"
            fail_count=0
            disable_hotspot
        else
            ((fail_count++)) || true
            log "Network check failed ($fail_count/$FAIL_THRESHOLD)"
            
            if [[ $fail_count -ge $FAIL_THRESHOLD ]]; then
                enable_hotspot
            fi
        fi
        
        sleep "$CHECK_INTERVAL"
    done
}

main
```

### 8.3 tether.toml (Default Configuration)

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/config/tether.toml`**

```toml
# Tether Configuration
# This file is created on first boot and updated via the web UI

[device]
# Device identifier (populated on first boot)
id = "{{DEVICE_ID}}"

[server]
# HTTP server settings
host = "0.0.0.0"
port = 3000

[bluetooth]
# Target Bluetooth device to track (configured via web UI)
# target_address = "AA:BB:CC:DD:EE:FF"
# target_name = "iPhone"
# signal_threshold = -70  # RSSI threshold for "nearby"

[passes]
# Number of passes allowed per month
monthly_limit = 3

[timezone]
# System timezone (configured via web UI)
# timezone = "America/New_York"

[wifi]
# Configured WiFi networks are managed by NetworkManager
# This section is for reference only

[hotspot]
# Hotspot configuration
ssid = "TetherSetup"
interface = "wlan0"
```

### 8.4 nginx/tether.conf

**File: `/Users/jeffrey/code/tether/deploy/pi/sdm/assets/nginx/tether.conf`**

```nginx
# Nginx configuration for Tether Web UI

server {
    listen 80 default_server;
    listen [::]:80 default_server;
    
    server_name tether.local _;
    
    root /opt/tether/web-ui;
    index index.html;
    
    # Gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    
    # API proxy to tether-server
    location /api/ {
        proxy_pass http://127.0.0.1:3000/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support (if needed later)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # OpenAPI spec
    location /openapi.json {
        proxy_pass http://127.0.0.1:3000/openapi.json;
        proxy_set_header Host $host;
    }
    
    # Static files - SPA routing
    location / {
        try_files $uri $uri/ /index.html;
        
        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # Health check endpoint
    location /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }
}
```

---

## 8. Testing the Image

### 8.1 Flashing to SD Card

**Option A: Using dd (Linux/macOS)**

```bash
# Identify SD card device (BE VERY CAREFUL - wrong device = data loss!)
lsblk

# Assuming SD card is /dev/sdX (replace X with actual letter)
# DO NOT use a partition (like /dev/sdX1), use the raw device

# Unmount any mounted partitions
sudo umount /dev/sdX* 2>/dev/null || true

# Flash the image
sudo dd if=deploy/pi/sdm/output/tether-pi-YYYYMMDD-HHMMSS.img of=/dev/sdX bs=4M status=progress conv=fsync

# Sync to ensure all data is written
sync

# Safely eject
sudo eject /dev/sdX
```

**Option B: Using Raspberry Pi Imager**

1. Download and install [Raspberry Pi Imager](https://www.raspberrypi.com/software/)
2. Click "Choose OS" -> "Use custom" -> Select the .img file
3. Click "Choose Storage" -> Select your SD card
4. Click "Write"

### 8.2 First Boot Verification

**Step 1: Initial Power On**

1. Insert SD card into Pi Zero 2 W
2. Connect power (USB)
3. Wait 60-90 seconds for first boot (LED will blink)

**Step 2: Connect to Hotspot**

1. On your phone/computer, look for WiFi network: `TetherSetup`
2. Connect (no password required for initial setup)
3. Open browser and navigate to `http://192.168.4.1`

**Step 3: Verify Services (via SSH after WiFi configured)**

```bash
# SSH into the Pi (default credentials: tether/tether)
ssh tether@tether.local
# or
ssh tether@<ip-address>

# Check all tether services
sudo systemctl status tether
sudo systemctl status tether-dumbpipe
sudo systemctl status tether-hotspot
sudo systemctl status tether-network-monitor
sudo systemctl status nginx
sudo systemctl status bluetooth

# Check logs
tail -f /opt/tether/logs/tether.log
tail -f /opt/tether/logs/firstboot.log

# Verify API is responding
curl http://localhost:3000/health
curl http://localhost:3000/openapi.json

# Check Bluetooth is working
bluetoothctl show

# Check network
nmcli device status
nmcli connection show
```

### 8.3 Troubleshooting Commands

```bash
# View full service logs
journalctl -u tether -f
journalctl -u tether-dumbpipe -f

# Check if binaries are in place
ls -la /opt/tether/bin/
file /opt/tether/bin/tether-server

# Check permissions
ls -la /opt/tether/
ls -la /opt/tether/config/

# View system messages from boot
journalctl -b

# Check first-boot script ran
cat /opt/tether/logs/firstboot.log

# Manually restart services
sudo systemctl restart tether
sudo systemctl restart nginx

# Force hotspot mode
sudo /opt/tether/scripts/tether-hotspot.sh enable

# Check web UI files
ls -la /opt/tether/web-ui/

# Test nginx config
sudo nginx -t
```

### 8.4 Verification Checklist

| Check | Command | Expected Result |
|-------|---------|-----------------|
| tether service running | `systemctl is-active tether` | `active` |
| nginx running | `systemctl is-active nginx` | `active` |
| API responding | `curl localhost:3000/health` | HTTP 200 |
| Web UI accessible | `curl localhost/` | HTML content |
| Bluetooth available | `bluetoothctl show` | Controller info |
| Config file exists | `cat /opt/tether/config/tether.toml` | TOML content |
| Data directory created | `ls /opt/tether/data/` | `.initialized` file |
| Logs being written | `ls /opt/tether/logs/` | `*.log` files |
| NetworkManager running | `nmcli general status` | `connected` state |

---

## Summary: Complete Build Command

```bash
# From the project root, on a Linux machine with sdm installed:

cd /path/to/tether

# 1. Build cross-compiled binaries
cargo build --release --target armv7-unknown-linux-gnueabihf

# 2. Build web UI
cd web-ui && bun run build && cd ..

# 3. Build the Pi image
sudo deploy/pi/sdm/build-image.sh

# Output will be in: deploy/pi/sdm/output/tether-pi-YYYYMMDD-HHMMSS.img
```

---

## Sources

- [sdm GitHub Repository](https://github.com/gitbls/sdm)
- [sdm Plugins Documentation](https://github.com/gitbls/sdm/blob/master/Docs/Plugins.md)
- [sdm Plugin Programming Guide](https://github.com/gitbls/sdm/blob/master/Docs/Programming-Plugins-and-Custom-Phase-Scripts.md)
- [sdm Example Commands](https://github.com/gitbls/sdm/blob/master/Docs/Example-Commands.md)
- [Raspberry Pi OS Downloads](https://www.raspberrypi.com/software/operating-systems/)

---

### Critical Files for Implementation

1. **`/Users/jeffrey/code/tether/deploy/pi/sdm/build-image.sh`** - Main build orchestration script that downloads base image, prepares assets, and runs sdm with all plugins in correct order
2. **`/Users/jeffrey/code/tether/deploy/pi/sdm/plugins/tether`** - Custom sdm plugin that copies binaries, sets permissions, creates first-boot scripts, and configures tether-specific settings across all three phases
3. **`/Users/jeffrey/code/tether/deploy/pi/sdm/configs/apps.txt`** - Package list for the apps plugin defining all APT packages to install (nginx, bluez, network-manager, etc.)
4. **`/Users/jeffrey/code/tether/deploy/pi/sdm/assets/systemd/tether.service`** - Primary systemd service file defining how tether-server runs, its dependencies, security settings, and restart behavior
5. **`/Users/jeffrey/code/tether/deploy/pi/sdm/assets/scripts/tether-hotspot.sh`** - Critical script that manages the WiFi hotspot for initial configuration and network fallback, integrating with NetworkManager via nmcli
